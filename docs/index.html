<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="v1.2.2-RC,2017-11-29">
<title>Dew-Framework（轻量服务框架）</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Dew-Framework（轻量服务框架）</h1>
<div class="details">
<span id="author" class="author">v1.2.2-RC,2017-11-29</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#truedew-framework">1. Dew-Framework</a>
<ul class="sectlevel2">
<li><a href="#true-">1.1. 设计理念</a>
<ul class="sectlevel3">
<li><a href="#true--2">1.1.1. 服务框架的尴尬</a></li>
<li><a href="#truedew">1.1.2. Dew框架思想</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#true--3">2. 新手入门</a>
<ul class="sectlevel2">
<li><a href="#true--4">2.1. 构建一个脚手架工程</a></li>
<li><a href="#true--5">2.2. 添加数据访问处理</a></li>
<li><a href="#true--6">2.3. 添加逻辑服务</a></li>
<li><a href="#true-web">2.4. 添加Web支持</a></li>
<li><a href="#true--7">2.5. 开始测试</a></li>
<li><a href="#true--8">2.6. 打包发布</a></li>
<li><a href="#truenext">2.7. Next!</a></li>
</ul>
</li>
<li><a href="#true--9">3. 使用手册</a>
<ul class="sectlevel2">
<li><a href="#truelet-s-begin">3.1. Let&#8217;s Begin</a>
<ul class="sectlevel3">
<li><a href="#true--10">3.1.1. 结构说明</a></li>
<li><a href="#true--11">3.1.2. 功能模块</a></li>
<li><a href="#true--12">3.1.3. 启动类</a></li>
<li><a href="#true--13">3.1.4. 配置说明</a></li>
<li><a href="#true--14">3.1.5. 日志框架</a></li>
<li><a href="#true--15">3.1.6. 业务初始化操作</a></li>
</ul>
</li>
<li><a href="#true--16">3.2. 核心</a>
<ul class="sectlevel3">
<li><a href="#true--17">3.2.1. 常用工具</a></li>
<li><a href="#trueweb">3.2.2. Web处理</a></li>
<li><a href="#true--22">3.2.3. 数据访问</a></li>
<li><a href="#true--25">3.2.4. 集群功能</a></li>
</ul>
</li>
<li><a href="#true--28">3.3. 增强</a>
<ul class="sectlevel3">
<li><a href="#true--29">3.3.1. 服务脚手架</a></li>
<li><a href="#true--30">3.3.2. 权限认证</a></li>
<li><a href="#true--31">3.3.3. 追踪日志</a></li>
<li><a href="#truedubbo">3.3.4. Dubbo兼容</a></li>
<li><a href="#truesharding-jdbc">3.3.5. sharding-jdbc集成</a></li>
<li><a href="#true--32">3.3.6. 幂等支持</a></li>
</ul>
</li>
<li><a href="#true--33">3.4. 工程化</a>
<ul class="sectlevel3">
<li><a href="#true--34">3.4.1. 代码质量检查</a></li>
<li><a href="#true--35">3.4.2. 测试支持</a></li>
<li><a href="#true-code-spring-admin-code">3.4.3. <code>Spring Admin</code> 集成</a></li>
<li><a href="#true--36">3.4.4. 服务调用开发期优化</a></li>
<li><a href="#true-code-hystrix-code">3.4.5. <code>hystrix</code> 降级增加邮件通知</a></li>
<li><a href="#true-code-api-code">3.4.6. <code>服务API调用</code> （追踪）日志处理</a></li>
<li><a href="#truetps">3.4.7. TPS查询接口</a></li>
<li><a href="#truedew-2">3.4.8. Dew 启动类配置多样性</a></li>
</ul>
</li>
<li><a href="#truejdbc">3.5. JDBC框架的选择</a></li>
<li><a href="#true--37">3.6. 服务调用开发期使用</a></li>
<li><a href="#true--38">3.7. 断路保护</a></li>
<li><a href="#true--39">3.8. 配置中心</a></li>
<li><a href="#true-code-ribbon-code">3.9. <code>ribbon</code> 负载均衡</a></li>
<li><a href="#true-code-feign-code">3.10. <code>feign</code> 配置特定方法超时时间</a></li>
<li><a href="#true--40">3.11. 主要性能影响参数</a></li>
<li><a href="#true--41">3.12. 缓存处理</a></li>
<li><a href="#true--42">3.13. 日志处理</a></li>
<li><a href="#trueservo">3.14. servo 内存泄漏问题</a></li>
<li><a href="#true-validated">3.15. '@Validated'注解</a></li>
<li><a href="#truejackson-java8-springmvc-jackson-json">3.16. jackson对于java8时间转换（springmvc以jackson接收json数据）</a></li>
<li><a href="#trueswagger">3.17. swagger离线文档</a></li>
<li><a href="#true-code-feign-code-http">3.18. <code>feign</code> 接口添加http请求头信息</a></li>
<li><a href="#true-code-zuul-code-http">3.19. <code>zuul</code> 保护(隐藏)内部服务的http接口</a></li>
<li><a href="#truespring-boot-admin">3.20. Spring Boot Admin 监控实践</a></li>
</ul>
</li>
<li><a href="#true--43">4. 技术指标</a>
<ul class="sectlevel2">
<li><a href="#true--44">4.1. 性能</a></li>
</ul>
</li>
<li><a href="#true--45">5. 开发指南</a>
<ul class="sectlevel2">
<li><a href="#truescm">5.1. SCM</a></li>
<li><a href="#true--46">5.2. 环境要求</a></li>
</ul>
</li>
<li><a href="#true--47">6. 编译部署</a>
<ul class="sectlevel2">
<li><a href="#true--48">6.1. 开发期热部署</a></li>
<li><a href="#true--49">6.2. 打包</a></li>
<li><a href="#true--50">6.3. 部署</a>
<ul class="sectlevel3">
<li><a href="#true--51">6.3.1. 准备</a></li>
<li><a href="#true--52">6.3.2. 手工发布</a></li>
<li><a href="#trueci">6.3.3. CI</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#true--53">7. 配置速查</a>
<ul class="sectlevel2">
<li><a href="#true-code-dew-code">7.1. <code>Dew</code> 参数</a></li>
<li><a href="#true-code-spring-boot-code">7.2. <code>Spring boot</code> 核心参数</a></li>
<li><a href="#true-code-druid-code">7.3. <code>Druid</code> 连接池参数</a></li>
<li><a href="#true-code-spring-cloud-code">7.4. <code>Spring cloud</code> 核心参数</a></li>
</ul>
</li>
<li><a href="#true--54">8. 版本说明</a>
<ul class="sectlevel2">
<li><a href="#true1-2-0-rc">8.1. 1.2.2-RC</a>
<ul class="sectlevel3">
<li><a href="#truefeature">8.1.1. Feature</a></li>
<li><a href="#trueimprovement">8.1.2. Improvement</a></li>
<li><a href="#truefixed">8.1.3. Fixed</a></li>
<li><a href="#true-code-1-1-0-rc-code-code-1-2-0-rc-code">8.1.4. 从 <code>1.1.0-RC</code> 迁移到 <code>1.2.2-RC</code></a></li>
</ul>
</li>
<li><a href="#true1-1-0-rc">8.2. 1.1.0-RC</a>
<ul class="sectlevel3">
<li><a href="#truefeature-2">8.2.1. Feature</a></li>
<li><a href="#trueimprovement-2">8.2.2. Improvement</a></li>
<li><a href="#truefixed-2">8.2.3. Fixed</a></li>
<li><a href="#true-code-1-1-0-beta1-code-code-1-1-0-rc-code">8.2.4. 从 <code>1.1.0-beta1</code> 迁移到 <code>1.1.0-RC</code></a></li>
</ul>
</li>
<li><a href="#true1-1-0-beta1">8.3. 1.1.0-beta1</a>
<ul class="sectlevel3">
<li><a href="#truefeature-3">8.3.1. Feature</a></li>
<li><a href="#trueimprovement-3">8.3.2. Improvement</a></li>
<li><a href="#truefixed-3">8.3.3. Fixed</a></li>
<li><a href="#true-code-1-0-0-rc-betax-code-code-1-1-0-code">8.3.4. 从 <code>1.0.0-RC/betaX</code> 迁移到 <code>1.1.0</code></a></li>
</ul>
</li>
<li><a href="#true1-0-0-rc">8.4. 1.0.0-RC</a>
<ul class="sectlevel3">
<li><a href="#truefeature-4">8.4.1. Feature</a></li>
<li><a href="#trueimprovement-4">8.4.2. Improvement</a></li>
<li><a href="#truefixed-4">8.4.3. Fixed</a></li>
</ul>
</li>
<li><a href="#true1-0-0-beta5">8.5. 1.0.0-beta5</a>
<ul class="sectlevel3">
<li><a href="#truefeature-5">8.5.1. Feature</a></li>
<li><a href="#trueimprovement-5">8.5.2. Improvement</a></li>
<li><a href="#truefixed-5">8.5.3. Fixed</a></li>
</ul>
</li>
<li><a href="#true1-0-0-beta4">8.6. 1.0.0-beta4</a>
<ul class="sectlevel3">
<li><a href="#truefeature-6">8.6.1. Feature</a></li>
<li><a href="#trueimprovement-6">8.6.2. Improvement</a></li>
<li><a href="#truefixed-6">8.6.3. Fixed</a></li>
</ul>
</li>
<li><a href="#true1-0-0-beta3">8.7. 1.0.0-beta3</a>
<ul class="sectlevel3">
<li><a href="#truefeature-7">8.7.1. Feature</a></li>
<li><a href="#trueimprovement-7">8.7.2. Improvement</a></li>
<li><a href="#truefixed-7">8.7.3. Fixed</a></li>
</ul>
</li>
<li><a href="#true1-0-0-beta2">8.8. 1.0.0-Beta2</a>
<ul class="sectlevel3">
<li><a href="#truefeature-8">8.8.1. Feature</a></li>
<li><a href="#trueimprovement-8">8.8.2. Improvement</a></li>
<li><a href="#truefixed-8">8.8.3. Fixed</a></li>
</ul>
</li>
<li><a href="#true1-0-0-beta1">8.9. 1.0.0-beta1</a>
<ul class="sectlevel3">
<li><a href="#truefeature-9">8.9.1. Feature</a></li>
<li><a href="#trueimprovement-9">8.9.2. Improvement</a></li>
<li><a href="#truefixed-9">8.9.3. Fixed</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#true--55">9. 路线图</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="truedew-framework"><a class="anchor" href="#truedew-framework"></a>1. Dew-Framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>对Spring Cloud/Boot的封装扩展、整合公司现有能力、提供最佳实践，做为基础服务框架，支撑公司新项目地研发。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Dew [du:] 意为<code>露水</code>，希望此框架可以像晨间的露水一样透明、静谧、丰盈。让使用者尽量不要感知框架的存在，专注业务实现。</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="true-"><a class="anchor" href="#true-"></a>1.1. 设计理念</h3>
<div class="sect3">
<h4 id="true--2"><a class="anchor" href="#true--2"></a>1.1.1. 服务框架的尴尬</h4>
<div class="paragraph">
<p>几乎每个软件公司都会研发企业内部的服务框架以满足自身业务发展的需要，但几乎所有框架都会存在这样的尴尬：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>无法传承，框架的研发人员离职后没有可以接手</p>
</li>
<li>
<p>上手难度大，很多框架喜欢重复造轮子，做出来的与业界主流思想/标准格格不入，导致学习培训成本很高</p>
</li>
<li>
<p>功能片面，不通用，服务框架讲求通用性，尽量让整个公司使用同一套规范以方便维护，但很多框架只实现了某些特定场景的功能，无法通用化</p>
</li>
<li>
<p>维护成本高，尤其是对于完全自研的框架，往往需要专职人员维护</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="truedew"><a class="anchor" href="#truedew"></a>1.1.2. Dew框架思想</h4>
<div class="paragraph">
<p>上述问题是Dew框架必须面对的，应对的设计核心理念是：<strong>基于成熟框架扩展</strong> ，具体要做到：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>简单容易，用最通用的、标准的、开发人员都熟悉的开发模型</p>
</li>
<li>
<p>功能全面，尽量重用市场已有能力实现，减少框架自身的维护成本</p>
</li>
<li>
<p>轻量，原则上不引入高侵入性的三方框架/类库</p>
</li>
<li>
<p>可替换，只做扩展，尽量不修改基础框架代码，开发人员完全可以直接基于基础框架开发</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>实现上我们选择 <code>Spring Boot/Cloud</code> 这一业界主流框架。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--3"><a class="anchor" href="#true--3"></a>2. 新手入门</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">使用申明</div>
<div class="paragraph">
<p><code>SNAPSHOT</code> 版本未经过测试，不得用于生产。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>本章节将以大名鼎鼎的 Pet Store 为例子介绍如何使用此框架。
<a href="https://www.google.ca/search?dcr=0&amp;q=pet+store+sample+application&amp;oq=pet+store+sample+application&amp;gs_l=psy-ab.3..0i7i30k1l3.75349.75349.0.75740.1.1.0.0.0.0.388.388.3-1.1.0.foo%2Ccfro%3D1%2Cnso-ehuqi%3D1%2Cnso-ehuui%3D1%2Cewh%3D0%2Cnso-mplt%3D2%2Cnso-enksa%3D0%2Cnso-enfk%3D1%2Cnso-usnt%3D1%2Cnso-qnt-npqp%3D0-1701%2Cnso-qnt-npdq%3D0-54%2Cnso-qnt-npt%3D0-1%2Cnso-qnt-ndc%3D300%2Ccspa-dspm-nm-mnp%3D0-05%2Ccspa-dspm-nm-mxp%3D0-125%2Cnso-unt-npqp%3D0-17%2Cnso-unt-npdq%3D0-54%2Cnso-unt-npt%3D0-0602%2Cnso-unt-ndc%3D300%2Ccspa-uipm-nm-mnp%3D0-007525%2Ccspa-uipm-nm-mxp%3D0-052675&#8230;&#8203;0&#8230;&#8203;1.1.64.psy-ab..0.1.387.w0jrLVcL93k">Pet Store In Google</a></p>
</div>
<div class="paragraph">
<p>本章节的代码见：example/guide-petstore</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--4"><a class="anchor" href="#true--4"></a>2.1. 构建一个脚手架工程</h3>
<div class="ulist">
<ul>
<li>
<p>建立 <code>guide-petstore</code> 目录，添加 <code>pom.xml</code> 文件，加入如下内容：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;!--引入Dew父依赖，也可以使用import方式--&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
        &lt;artifactId&gt;parent&lt;/artifactId&gt;
        &lt;!--生产环境切不可以使用快照版本!!!!!!!!--&gt;
        &lt;version&gt;1.2.2-RC&lt;/version&gt;
    &lt;/parent&gt;

    &lt;groupId&gt;yourgroup&lt;/groupId&gt;
    &lt;artifactId&gt;pet-store&lt;/artifactId&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;

    &lt;dependencies&gt;
        &lt;!--dew的核心包--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
            &lt;artifactId&gt;boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--引入集群能力-redis实现--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
            &lt;artifactId&gt;cluster-spi-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--添加web（spring mvc）功能--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--添加文档支持--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.springfox&lt;/groupId&gt;
            &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.springfox&lt;/groupId&gt;
            &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--引入JDBC依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
            &lt;artifactId&gt;jdbc-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--测试项目，使用h2数据库--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--引入Dew封装的单元测试功能--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
            &lt;artifactId&gt;test-starter&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>parent</code> 中已包含各模块的版本，引用模块依赖时可省略版本号。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>dew</code> 支持 <code>Spring boot</code> 下各类数据持久化框架，此处使用基于 <code>Spring jdbc template</code> 封装的轻量实现，此实现对应的连接池必须为 <code>Druid</code> 。
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>添加添加文件到 <code>src/main/resources/application.yml</code> ，内容如下：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
  cache:
    type: redis
  application:
    name: pet-store # 项目名称，对Spring Cloud而言也是service-id
  datasource: # 数据库连接信息
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:petstore
  redis: # Redis连接信息
    host: localhost
    port: 6379
    database: 0

server: # http端口号
  port: 8080

dew:
  basic:
    name: pet-store
    version: 1.0
    desc: 宠物商店
    web-site:
    doc:
      base-package: your.group.controller # API文档路径
  cluster:
    cache: redis # 指定集群缓存实现为redis
  jdbc:
    base-packages: ["your.group.jdbc"]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>添加工程启动类</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * 工程启动类
 * 重写父类的ComponentScan，先扫描Dew下的包，再是项目的根包
 */
@DewBootApplication(scanBasePackageClasses = {Dew.class,PetStoreApplication.class})
public class PetStoreApplication {

    public static void main(String[] args) {
        new SpringApplicationBuilder(PetStoreApplication.class).run(args);
    }

}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>创建其它标准的目录及文件，结果如下：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>guide-petstore
    |-src
        |-main
            |-java
                |-your
                    \-group
                        \-PetStoreApplication.java
            \-resources
                |-application.yml
                \-logback-spring.xml
        |-test
    |-.gitignore
    |-pom.xml</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>.gitignore</code> 是标准的git忽略文件，<code>logback-spring.xml</code> 为 <code>logback</code> 在 <code>spring</code> 下的配置文件，与项目说明关系不大，详见源代码。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true--5"><a class="anchor" href="#true--5"></a>2.2. 添加数据访问处理</h3>
<div class="ulist">
<ul>
<li>
<p>添加数据初始化类到 <code>src/main/java/your/group/PetstoreInitiator.java</code> ，内容如下：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * 在根路径创建用于初始化数据/行为的类
 * &lt;p&gt;
 * 减少滥用PostConstruct造成的不可控因素
 */
@Component
public class PetstoreInitiator {

    @PostConstruct
    public void init() {
        // 初始宠物表
        ((DewDS) Dew.ds()).jdbc().execute("CREATE TABLE pet\n" +
                "(\n" +
                "id int primary key auto_increment,\n" +
                "type varchar(50),\n" +
                "price decimal(11,4) not null,\n" +
                "create_time datetime,\n" +
                "update_time datetime,\n" +
                "enabled bool\n" +
                ")");
        // 初始化客户表
        ((DewDS) Dew.ds()).jdbc().execute("CREATE TABLE customer\n" +
                "(\n" +
                "id int primary key auto_increment,\n" +
                "name varchar(50)\n" +
                ")");
        // 初始化订单表
        ((DewDS) Dew.ds()).jdbc().execute("CREATE TABLE t_order\n" +
                "(\n" +
                "id int primary key auto_increment,\n" +
                "pet_id int,\n" +
                "customer_id int,\n" +
                "price decimal(11,4) not null,\n" +
                "create_time datetime \n" +
                ")");
    }

}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>添加数据对象到 <code>src/main/java/your/group/entity</code> 下，共3个类：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Entity
public class Pet {

    @PkColumn
    private int id;
    @Column(notNull = true)
    private String type;
    @Column(notNull = true)
    private BigDecimal price;
    @CreateTimeColumn
    private LocalDateTime createTime;
    @UpdateTimeColumn
    private LocalDateTime updateTime;
    @EnabledColumn
    private boolean enabled;

    // get/set...
}

@Entity
public class Customer {

    @PkColumn
    private int id;
    @Column(notNull = true)
    private String name;

    // get/set...
}

@Entity(tableName = "t_order") // order对象对应的是t_order表
public class Order {

    @PkColumn
    private int id;
    @Column(notNull = true)
    private int petId;
    @Column(notNull = true)
    private int customerId;

    // get/set...
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">注解说明</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>表名/字段名在注解中没有特别指定时均以驼峰转下划线规则处理</p>
</li>
<li>
<p><code>@PkColumn</code> 标识主键字段，支持int/String类型</p>
</li>
<li>
<p><code>@Column</code> 标识普通字段</p>
</li>
<li>
<p><code>@CreateTimeColumn/@UpdateTimeColumn</code> 标识创建/更新字段，会自动添加日期</p>
</li>
<li>
<p><code>@EnabledColumn</code> 标识状态字段，用于软删除操作</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>添加 <code>DAO</code> 到 <code>src/main/java/your/group/jdbc</code> 下，共3个接口：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public interface PetDao extends DewDao&lt;Integer, Pet&gt; {
}

public interface CustomerDao extends DewDao&lt;Integer, Customer&gt; {
}

public interface OrderDao extends DewDao&lt;Integer, Order&gt; {

    @Select(value = "SELECT ord.* FROM t_order ord " +
            "INNER JOIN pet p ON p.id = ord.pet_id " +
            "WHERE ord.customer_id = #{customerId} AND p.type = #{petType}",entityClass = Order.class)
    Page&lt;Order&gt; findOrders(@Param("customerId") int customerId, @Param("petType") String petType,
                           @Param("pageNumber") long pageNumber, @Param("pageSize") int pageSize);

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">DAO说明</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>DewDao</code> 是所有DAO的父类，实现了基础的CRUD方法</p>
</li>
<li>
<p><code>@Select</code> 允许自定义查询语句</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true--6"><a class="anchor" href="#true--6"></a>2.3. 添加逻辑服务</h3>
<div class="ulist">
<ul>
<li>
<p>添加 <code>Service</code> 到 <code>src/main/java/your/group/service</code> 下，共3个类：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Service
@CacheConfig(cacheNames = "petstore:pet") // 启用缓存指定key前缀
public class PetService implements CRUSService&lt;PetDao, Integer, Pet&gt; {

    @Override
    @Cacheable // 缓存id对应的内容
    public Resp&lt;Pet&gt; getById(Integer id) {
        return CRUSService.super.getById(id);
    }

    @Override
    @CacheEvict // 清除id对应的内容
    public Resp&lt;Void&gt; disableById(Integer id) {
        return CRUSService.super.disableById(id);
    }

    @Override
    @CachePut("#pet.id") // 添加/更新id对应的内容
    public Resp&lt;Pet&gt; save(Pet pet) {
        return CRUSService.super.save(pet);
    }

    @Override
    @CachePut("#id")// 添加/更新id对应的内容
    public Resp&lt;Pet&gt; updateById(Integer id, Pet pet) {
        return CRUSService.super.updateById(id, pet);
    }
}

@Service
public class CustomerService implements CRUDSService&lt;CustomerDao, Integer, Customer&gt; {
}

@Service
public class OrderService implements CRUService&lt;OrderDao, Integer, Order&gt; {

    // 使用分布式锁
    private ClusterDistLock lock;

    @Autowired
    private PetService petService;

    @PostConstruct
    public void init() {
        // 锁的初始化，写在@PostConstruct方法中
        lock = Dew.cluster.dist.lock("petstore:buy");
    }

    /**
     * 购买方法
     *
     * @return {@link Resp}
     */
    public Resp&lt;Void&gt; buy(int petId, int customerId) {
        Order order = new Order();
        order.setCustomerId(customerId);
        order.setPetId(petId);
        try {
            // 加锁，推荐加上锁过期时间
            if (lock.tryLock(100, 5000)) {
                if (petService.getById(petId).getBody().isEnabled()) {
                    // 只能未被购买的宠物才能购买
                    getDao().insert(order);
                    // 标记宠物已被购买
                    petService.disableById(petId);
                }
            } else {
                return Resp.locked("请求忙，请稍后重试");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return Resp.serverError("未知错误");
        } finally {
            // 解锁，不要忘了
            lock.unLock();
        }
        return Resp.success(null);
    }

    public Resp&lt;Page&lt;Order&gt;&gt; findOrders(int customerId, String petType, long pageNumber, int pageSize) {
        return Resp.success(getDao().findOrders(customerId, petType, pageNumber, pageSize));
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Service说明</div>
<div class="paragraph">
<p>框架提供了C(Create)R(Read)U(Update)D(Delete)S(Status,软删除)脚手架，对应于各个服务父类</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Resp 响应模型，用于统一请求响应处理</div>
<div class="paragraph">
<p>模型由三个属性组成：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>code：响应编码，同HTTP状态码，200表示成功</p>
</li>
<li>
<p>message：错误描述，当code不为200时用于描述错误信息</p>
</li>
<li>
<p>body：返回的实际对象</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true-web"><a class="anchor" href="#true-web"></a>2.4. 添加Web支持</h3>
<div class="ulist">
<ul>
<li>
<p>添加 <code>Service</code> 到 <code>src/main/java/your/group/controller</code> 下，共3个类：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RestController
@RequestMapping("pet/")
@Api(description = "宠物操作")
public class PetController implements CRUSController&lt;PetService, Integer, Pet&gt; {
}

@RestController
@RequestMapping("customer/")
@Api(description = "客户操作")
public class CustomerController implements CRUDController&lt;CustomerService, Integer, Customer&gt; {
}

@RestController
@RequestMapping("order/")
@Api(description = "订单操作")
public class OrderController implements CRUController&lt;OrderService, Integer, Order&gt; {

    @PostMapping("buy")
    @ApiOperation(value = "获取记录分页列表")
    public Resp&lt;Void&gt; buy(@Validated @RequestBody BuyVO buyVO) {
        return getService().buy(buyVO.getPetId(), buyVO.getCustomerId());
    }

    @GetMapping("{type}/{pageNumber}/{pageSize}")
    @ApiOperation(value = "获取记录分页列表")
    public Resp&lt;Page&lt;Order&gt;&gt; findOrders(@PathVariable String type, @RequestParam int customerId, @PathVariable long pageNumber, @PathVariable int pageSize) {
        return getService().findOrders(customerId, type, pageNumber, pageSize);
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Controller说明</div>
<div class="ulist">
<ul>
<li>
<p>和Service一样，框架提供了C(Create)R(Read)U(Update)D(Delete)S(Status,软删除)脚手架，对应于各个服务父类</p>
</li>
<li>
<p><code>@Api</code> <code>@ApiOperation</code> 为 <code>swagger</code> 文档的功能</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true--7"><a class="anchor" href="#true--7"></a>2.5. 开始测试</h3>
<div class="ulist">
<ul>
<li>
<p>添加 <code>Test</code> 到 <code>src/test/java/your/group/test/PetStoreTest.java</code> 下，内容如下：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RunWith(SpringRunner.class)
@SpringBootTest(classes = PetStoreApplication.class, webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)
@ComponentScan(basePackageClasses = {Dew.class, PetStoreApplication.class})
public class PetStoreTest {

    private static final String url = "http://127.0.0.1:8080/";

    @Test
    public void testAll() throws Exception {
        // 添加2个宠物
        $.http.post(url+"pet/", "{\"type\":\"dog\",\"price\":1000,\"enabled\":true}");
        $.http.post(url+"pet/", "{\"type\":\"dog\",\"price\":1000,\"enabled\":true}");
        // 添加一个客户
        Customer customer = Resp.generic($.http.post(url+"customer/", "{\"name\":\"张三\"}"), Customer.class).getBody();
        // 查看可购买的宠物列表，有2个
        List&lt;Pet&gt; pets = Resp.genericList($.http.get(url+"pet/?enabled=true"), Pet.class).getBody();
        Assert.assertEquals(2, pets.size());
        // 购买一个宠物
        $.http.post(url+"order/buy", "{\"petId\":\"" + pets.get(0).getId() + "\",\"customerId\":\"" + customer.getId() + "\"}");
        // 查看订单列表
        List&lt;Order&gt; orders = Resp.genericPage($.http.get(url+"order/dog/1/10?customerId=" + customer.getId()), Order.class).getBody().getObjects();
        Assert.assertEquals(1,orders.size());
        Assert.assertEquals(pets.get(0).getId(), orders.get(0).getPetId());
        // 查看可购买的宠物列表，只有1个
        pets = Resp.genericList($.http.get(url+"pet/?enabled=true"), Pet.class).getBody();
        Assert.assertEquals(1, pets.size());
    }

}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">测试说明</div>
<div class="paragraph">
<p>由于引用了</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
&lt;artifactId&gt;test-starter&lt;/artifactId&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>其自带了嵌入式的redis及h2数据库，所以无须第三方依赖即可使用。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true--8"><a class="anchor" href="#true--8"></a>2.6. 打包发布</h3>
<div class="ulist">
<ul>
<li>
<p>提交代码质检</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dew 已集成 <code>Sonar</code> 插件，只需要在maven中配置 <code>sonar.host.url</code> 为目标地址，然后执行 <code>mvn clean verify sonar:sonar -P qa</code> 即可。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>生成离线API文档</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">建立如下测试类</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RunWith(SpringRunner.class)
@SpringBootApplication
@SpringBootTest(classes = PetStoreApplication.class, webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)
@ComponentScan(basePackageClasses = {Dew.class, PetStoreApplication.class})
public class DocTest {

    @Test
    public void empty(){}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>mvn -Dtest=DocTest clean test -P doc</code></p>
</div>
<div class="paragraph">
<p>在项目路径下 <code>api-docs</code> 就可以看到生成的文档了。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>打包</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>mvn clean package -P fatjar</code></p>
</div>
</div>
<div class="sect2">
<h3 id="truenext"><a class="anchor" href="#truenext"></a>2.7. Next!</h3>
<div class="paragraph">
<p>此章节演示了 <code>Dew</code> 的基础使用，<code>Spring Cloud</code> 相关的内容也未涉及，更多使用请参见 <code>用户手册</code> 。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--9"><a class="anchor" href="#true--9"></a>3. 使用手册</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">使用申明</div>
<div class="paragraph">
<p><code>Dew</code> 有多个版本通道，使用时请谨慎选择：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>GA</code> General Availability，正式版本，通过内部测试没有已知错误并且经过生产验证，生产环境首选！</p>
</li>
<li>
<p><code>RC</code> Release Candidate，发行候选版本，通过内部测试没有已知错误，可用于生产环境。</p>
</li>
<li>
<p><code>Beta</code> 公开测试版本，没有已知的Major类型Bug，但允许存在个别minor类型Bugs，生产环境使用需要谨慎评估！</p>
</li>
<li>
<p><code>Alpha</code> 内容测试版本，很早期的测试版本，未经过内部测试，可能存在较多Bugs，此版本类似技术预览版（Technical Preview），切 <strong>不可</strong> 用于生产环境！</p>
</li>
<li>
<p><code>SNAPSHOT</code> 快照版本，类似Nightly版本，更新频繁此不保证质量，切 <strong>不可</strong> 用于生产环境！</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="truelet-s-begin"><a class="anchor" href="#truelet-s-begin"></a>3.1. Let&#8217;s Begin</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Dew</code> 框架是对 <code>Spring Boot/Cloud</code> 的扩展，使用之前务必了解相关框架的基础知识。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:guide-petstore、bone-example</pre>
</div>
</div>
<div class="sect3">
<h4 id="true--10"><a class="anchor" href="#true--10"></a>3.1.1. 结构说明</h4>
<div class="paragraph">
<p><code>Dew</code> 所有模块均为Maven结构，使用如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;!--引入Dew父依赖，也可以使用import方式--&gt;
&lt;parent&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;parent&lt;/artifactId&gt;
    &lt;!--生产环境请选择合适的版本!!!!!!!!--&gt;
    &lt;version&gt;${dew.version}&lt;/version&gt;
&lt;/parent&gt;
...
&lt;dependencies&gt;
    &lt;!--引入需要的模块--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
        &lt;artifactId&gt;&lt;模块名&gt;&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
...
&lt;!--开发者--&gt;
&lt;developers&gt;
    &lt;developer&gt;
        &lt;name&gt;&lt;/name&gt;
        &lt;email&gt;&lt;/email&gt;
    &lt;/developer&gt;
&lt;/developers&gt;
&lt;!--SCM信息--&gt;
&lt;scm&gt;
    &lt;connection&gt;&lt;/connection&gt;
    &lt;developerConnection&gt;&lt;/developerConnection&gt;
    &lt;url&gt;&lt;/url&gt;
&lt;/scm&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>parent</code> 中已包含各模块的版本，引用模块依赖时可省略版本号。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="true--11"><a class="anchor" href="#true--11"></a>3.1.2. 功能模块</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">模块名</th>
<th class="tableblock halign-left valign-top">核心功能</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boot-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基于Spring Boot的扩展，Dew的核心模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cloud-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基于Spring Cloud的扩展，基于<code>boot-starter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cloud-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">基于Spring Cloud的扩展，基于<code>boot-starter</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>idempotent-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">幂性处理模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jdbc-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dew JDBC模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>csp-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用户权限中心扩展模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-common</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力接口</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-redis</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力-Redis实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-hazelcast</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力-Hazelcast实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-ignite</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力-Ignite实现(开发中）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-rabbit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力-Rabbit实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cluster-eureka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力-Eureka实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>test-starter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dew的单元测试封装</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>config</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">统一配置中心组件</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>registry</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">服务注册中心组件</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gateway</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">服务网关组件</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>monitor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">服务监控组件</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;x&gt;-example</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">各类示例</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="true--12"><a class="anchor" href="#true--12"></a>3.1.3. 启动类</h4>
<div class="paragraph">
<p><code>Dew</code> 有两个核心启动类 <code>DewBootApplication</code> 和 <code>DewCloudApplication</code> ，前者引用的依赖是 <code>boot-starter</code> 用于启动 <code>Spring boot</code> 类型的工程，后者依赖的是<code>cloud-starter</code> 继承自 <code>DewBootApplication</code> 用于启动 <code>Spring cloud</code> 类型的工程。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">DewBootApplication使用如下注解</div>
<div class="paragraph">
<p>@SpringBootApplication<br>
@EnableTransactionManagement<br>
@EnableAutoConfiguration(exclude = {FreeMarkerAutoConfiguration.class, GsonAutoConfiguration.class, WebSocketAutoConfiguration.class})<br>
@ComponentScan(basePackageClasses = {Dew.class})<br>
@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)<br>
@EnableCaching(proxyTargetClass = true)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">DewCloudApplication使用如下注解</div>
<div class="paragraph">
<p>@SpringCloudApplication</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">@ComponentScan说明</div>
<div class="paragraph">
<p><code>Spring boot</code> 严重依赖于包扫描功能，所以工程中需要重写 <code>@ComponentScan</code> 加入当前工程的根包，要求为 <code>Dew</code> 包在前，工程包在后，如： <code>(basePackageClasses = {Dew.class,PetStoreApplication.class})</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
示例见 <code>example/guide-petstore</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="true--13"><a class="anchor" href="#true--13"></a>3.1.4. 配置说明</h4>
<div class="paragraph">
<p><code>Dew</code> 的配置使用 <code>Spring boot</code> 风格，尽量重用已有的配置， <code>Dew</code> 的特殊配置均在 <code>dew.</code> key下， 推荐使用 <code>yml</code> 格式。</p>
</div>
</div>
<div class="sect3">
<h4 id="true--14"><a class="anchor" href="#true--14"></a>3.1.5. 日志框架</h4>
<div class="paragraph">
<p>推荐使用 <code>logback</code> ， 使用 <code>logback-spring.xml</code> 文件配置日志核心处理。</p>
</div>
</div>
<div class="sect3">
<h4 id="true--15"><a class="anchor" href="#true--15"></a>3.1.6. 业务初始化操作</h4>
<div class="paragraph">
<p><code>Spring boot</code> 可使用 <code>@PostConstruct</code> 在 <code>bean</code> 加载时做业务初始化操作，它可位于任何类/包中，高度灵活的同时可能会导致初始化操作不可控， <code>Dew</code> 推荐在根包中建立名为 <code>&lt;project&gt;Initiator</code> 类，所有业务初始化操作都在此类中完成。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--16"><a class="anchor" href="#true--16"></a>3.2. 核心</h3>
<div class="sect3">
<h4 id="true--17"><a class="anchor" href="#true--17"></a>3.2.1. 常用工具</h4>
<div class="paragraph">
<p><code>Dew</code> 框架的常用工具由 <code>Dew-Common</code> 包提供（ <a href="https://github.com/gudaoxuri/dew-common" class="bare">https://github.com/gudaoxuri/dew-common</a> ），功能如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Json与Java对象互转，支持泛型</p>
</li>
<li>
<p>Java Bean操作，Bean复制、反射获取/设置注解、字段、方法等</p>
</li>
<li>
<p>Java Class扫描操作，根据注解或名称过滤</p>
</li>
<li>
<p>Shell脚本操作，Shell内容获取、成功捕获及进度报告等</p>
</li>
<li>
<p>加解密操作，Base64、MD5/BCrypt/SHA等对称算法和RSA等非对称算法</p>
</li>
<li>
<p>Http操作，包含Get/Post/Put/Delete/Head/Options操作</p>
</li>
<li>
<p>金额操作，金额转大写操作</p>
</li>
<li>
<p>通用拦截器栈，前/后置、错误处理等</p>
</li>
<li>
<p>定时器操作，定时和周期性任务</p>
</li>
<li>
<p>常用文件操作，根据不同情况获取文件内容</p>
</li>
<li>
<p>常用字段操作，各类字段验证、身份证提取、UUID创建等</p>
</li>
<li>
<p>常用时间处理，常规时间格式化模板</p>
</li>
<li>
<p>主流文件MIME整理，MIME分类</p>
</li>
<li>
<p>响应处理及分页模型</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><code>Dew Common</code> 的使用</div>
<div class="paragraph">
<p><code>Dew Common</code> 功能均以 <code>$</code> 开始，比如:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Json转成Java对象: <code>$.json.toObject(json,JavaModel.class)</code></p>
</li>
<li>
<p>Json字符串转成List对象: <code>$.json.toList(jsonArray, JavaModel.class)</code></p>
</li>
<li>
<p>Bean复制：<code>$.bean.copyProperties(ori, dist)</code></p>
</li>
<li>
<p>获取Class的注解信息: <code>$.bean.getClassAnnotation(IdxController.class, TestAnnotation.RPC.class)</code></p>
</li>
<li>
<p>非对称加密: <code>$.encrypt.Asymmetric.encrypt(d.getBytes("UTF-8"), publicKey, 1024, "RSA")</code></p>
</li>
<li>
<p>Http Get: <code>$.http.get("https://httpbin.org/get")</code></p>
</li>
<li>
<p>验证手机号格式是否合法: <code>$.field.validateMobile("18657120000")</code></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
完整使用手册见 <a href="https://gudaoxuri.github.io/dew-common/" class="bare">https://gudaoxuri.github.io/dew-common/</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueweb"><a class="anchor" href="#trueweb"></a>3.2.2. Web处理</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:web-example、cache-example</pre>
</div>
</div>
<div class="sect4">
<h5 id="true-web-2"><a class="anchor" href="#true-web-2"></a>基础Web使用</h5>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;!--dew的核心包--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
        &lt;artifactId&gt;boot-starter&lt;/artifactId&gt;
        &lt;version&gt;${dew.version}&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--Spring Boot Web核心依赖--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!--添加文档支持--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.springfox&lt;/groupId&gt;
        &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.springfox&lt;/groupId&gt;
        &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
…</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">添加配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
  application:
    name: web-example

server:
  port: 8080 # http端口号

dew:
  basic:
    name: web
    version: 1.0
    desc: desc
    web-site: www.ecfront.com
    doc:
      base-package: com.ecfront # API文档路径</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">添加Controller</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RestController
public class ExampleController {
   @GetMapping("/example")
   public String example() {
       return "enjoy!";
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Controller</code> 的操作请参见 <code>Spring boot</code> 文档
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="truecors"><a class="anchor" href="#truecors"></a>CORS支持</h5>
<div class="paragraph">
<p><code>CORS</code> 默认支持</p>
</div>
<div class="listingblock">
<div class="title"><code>CORS</code>实现定制</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
  security:
    cors:
      allow-origin: # 允许来源，默认 *
      allow-methods: # 允许方法，默认 POST,GET,OPTIONS,PUT,DELETE,HEAD
      allow-headers: # 允许头信息 x-requested-with,content-type</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true--18"><a class="anchor" href="#true--18"></a>数据验证</h5>
<div class="paragraph">
<p><code>Dew</code> 集成了 <code>Spring validate</code> 机制，支持针对 <code>URL</code> 及 <code>Bean</code> 的验证。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在 java bean 中添加各项validation，支持标准<code>javax.validation.constraints</code>包下的诸如：<code>NotNull</code> ，同时框架扩展了几个检查，如：
IdNumber、Phone</p>
</li>
<li>
<p>在Controller中添加 <code>@Validated</code> 注解 ( Spring还支持@Vaild，但这一注解不支持分组 )</p>
</li>
<li>
<p>支持Spring原生分组校验</p>
</li>
<li>
<p><code>URL</code> 类型的验证必须在类头添加 <code>@Validated</code> 注解</p>
</li>
<li>
<p><code>Dew</code> 框架内置了 <code>CreateGroup</code> <code>UpdateGroup</code> 两个验证组，验证组仅是一个标识，可为任何java对象</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">修改之前的Controller</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RestController
@Api(description = "示例应用")
@Validated // URL 类型的验证需要使用此注解
public class WebExampleController {

    /**
     * 最基础的Controller示例
     */
    @GetMapping("example")
    @ApiOperation(value = "示例方式")
    public String example() {
        return "enjoy!";
    }

    /**
     * 数据验证示例，针对 CreateGroup 这一标识组的 bean认证
     */
    @PostMapping(value = "valid-create")
    public String validCreate(@Validated(CreateGroup.class) @RequestBody User user) {
        return "";
    }

    /**
     * 数据验证示例，针对 UpdateGroup 这一标识组的 bean认证，传入的是表单形式
     */
    @PutMapping(value = "valid-update")
    public String validUpdate(@Validated(UpdateGroup.class) User user) {
        return "";
    }

    /**
     * 数据验证示例，URL认证
     */
    @GetMapping(value = "valid-method/{age}")
    public String validInMethod(@Min(value = 2,message = "age必须大于2") @PathVariable("age") int age) {
        return "";
    }

    // User类
    public static class User {

        // 仅在CreateGroup组下才校验
        @NotNull(groups = CreateGroup.class)
        @IdNumber(message = "身份证号错误", groups = CreateGroup.class)
        private String idCard;

        // CreateGroup、UpdateGroup组下校验
        @Min(value = 10, groups = {CreateGroup.class, UpdateGroup.class})
        private int age;

        // CreateGroup、UpdateGroup组下校验
        @Phone(message = "手机号错误", groups = {CreateGroup.class, UpdateGroup.class})
        private String phone;

        // Get/Set...
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true--19"><a class="anchor" href="#true--19"></a>统一响应</h5>
<div class="paragraph">
<p><code>Dew</code> 支持两种格式：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>协议无关：<code>Resp&lt;E&gt;</code> 响应，对于 <code>HTTP</code> 统一返回 <code>200</code> (业务操作不需要降级) 或 <code>1000</code> (业务操作需要降级) HTTP状态码，使用 <code>code</code> 表示业务状态码，<code>Resp</code> 对象包含:</p>
<div class="literalblock">
<div class="content">
<pre>code 响应编码，与http状态码类似，200表示成功
message 响应附加消息，多有于错误描述
body 响应正文</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Resp</code>类提供了常用操作：详见 <a href="https://gudaoxuri.github.io/dew-common/#true-resp">https://gudaoxuri.github.io/dew-common/#true-resp</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">1000 Http状态码说明</div>
<div class="paragraph">
<p><code>1000</code> 状态码仅用于告诉 <code>Hystrix</code> 这次请求是需要降级的错误，对于 <code>Resp</code> 中的 <code>code</code> 没有影响。</p>
</div>
<div class="paragraph">
<p><code>dew</code> 框架会把所有 <code>5xx</code>（服务端错误，需要降级） 的异常统一转换成 <code>1000</code> 的Http状态码返回给调用方。</p>
</div>
<div class="paragraph">
<p><code>Resp.xxx.fallback()</code> 用于显示声明当前返回需要降级，
比如 <code>Resp.serverError("some message")</code> 不会降级，返回http状态码为200，body为 <code>{"code":"500","message":"some message","body":null}</code>，
但 <code>Resp.serverError("some message").fallback()</code> 会降级，返回http状态码为1000，body为 同上。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>重用<code>HTTP Status Code</code>: 在无错误时直接返回内容，发生错误时返回 <code>{"error":{"code":"实际错误码","message":"错误信息"}}</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如果启用了字段检查（ <code>@RequestBody @Validated &#8230;&#8203;</code> ），在检查不通过时上述两种格式的 <code>message</code> 内容会返回Json格式的错误详细（ <code>Detail:</code> 标识之后的内容），格式为：
     <code>[{"field":"&lt;字段名&gt;","reason":"&lt;原因，如NotNull,Min&gt;","msg":"&lt;错误描述&gt;"}]</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>启用统一响应格式支持：</p>
</div>
<div class="listingblock">
<div class="title">统一响应格式配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
    basic:
        format:
            use-unity-error: true # 是否启用统一响应，默认true
            reuse-http-state: false # true:重用http状态码，false:使用协议无关格式，默认false</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">统一响应使用</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// 使用协议无关格式
public Resp&lt;String&gt; test(){
    return Resp.success("enjoy!");
    // or return Resp.notFound("…")/conflict("…")/badRequest("…")/…
}

// 重用http状态码
// 与协议无关格式区别在于：
// 1. throws 对应的异常
// 2. 使用Dew.E.e(&lt;code&gt;,&lt;Exception Instance&gt;)来抛出异常
public String test() throws IOException{
    return "enjoy!";
    // or throw Dew.E.e("A000", new IOException("io error"));
    // or throw Dew.E.e("A000", new IOException("io error"),StandardCode.UNAUTHORIZED); // 自定义http异常401
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">统一响应格式的选择</div>
<div class="paragraph">
<p><code>Dew</code> 推荐使用 <code>协议无关格式</code>，此格式在 <code>方法间调用</code> <code>非HTTP协议RPC</code> <code>MQ</code> 等数据交互场景做到真正的 <code>统一响应格式</code>。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="true--20"><a class="anchor" href="#true--20"></a>异常处理</h5>
<div class="paragraph">
<p><code>Dew</code> 会把程序没有捕获的异常统一转成 <code>500</code> 异常上抛，同时框架提供了常用的异常检查：</p>
</div>
<div class="listingblock">
<div class="title">异常检查，异常类型要求为RuntimeException及其子类</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">Dew.E.check(VoidPredicate notExpected, E ex)
Dew.E.check(boolean notExpected, E ex)
Dew.E.checkNotEmpty(Map&lt;?, ?&gt; objects, E ex)
Dew.E.checkNotEmpty(Iterable&lt;?&gt; objects, E ex)
Dew.E.checkNotNull(Object obj, E ex)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">自定义异常配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">dew:
  basic:
    format:
      use-unity-error: true // 这个必须为true
    error-mapping:
      "[&lt;异常类名&gt;]":
        http-code: # http状态码，不存在时使用实例级http状态码
        business-code: # 业务编码，不存在时使用实例级业务编码
        message: # 错误描述，不存在时使用实例级错误描述

&lt;!--示例--&gt;
dew:
  basic:
    format:
      use-unity-error: true
    error-mapping:
      "[com.ecfront.dew.core.AuthException]":
        http-code: 401
        business-code: x00010
        message: 认证错误</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true--21"><a class="anchor" href="#true--21"></a>注解式缓存</h5>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">配置注解式缓存</div>
<div class="paragraph">
<p>spring:
  cache:
    type: # 支持 redis hazelcast 等</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Dew</code> 支持 <code>Spring Boot</code> 的缓存注解，详见示例 <code>example/cache-example</code></p>
</div>
</div>
<div class="sect4">
<h5 id="true-api"><a class="anchor" href="#true-api"></a>访问在线API文档</h5>
<div class="paragraph">
<p>在 <code>default</code> <code>test</code> <code>dev</code> profile下http访问 <code>./swagger-ui.html</code> 即可。</p>
</div>
</div>
<div class="sect4">
<h5 id="true-api-2"><a class="anchor" href="#true-api-2"></a>生成离线API文档</h5>
<div class="paragraph">
<p>实现Html及PDF版本的离线API文档，效果如下：</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="http://swagger2markup.github.io/swagger2markup/1.3.1/images/Swagger2Markup.PNG" alt="Swagger2Markup.PNG"></span></p>
</div>
<div class="listingblock">
<div class="title">建立如下测试类，WebExampleApplication修改成对应的启动类</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@RunWith(SpringRunner.class)
@SpringBootTest(classes = WebExampleApplication.class, webEnvironment = SpringBootTest.WebEnvironment.DEFINED_PORT)
public class DocTest {

    @Test
    public void empty(){}

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">执行如下命令(加上 <code>-Dapi.file.name= [name]</code> 可指定文件名)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell" data-lang="shell">mvn -Dtest=DocTest clean test -P doc

mvn -Dtest=DocTest -Dapi.file.name=dew-example clean test -P doc</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>查看工程目录，多了一个 <code>api-docs</code> 的目录，包含了 <code>index.html</code> 和 <code>index.pdf</code> 两个离线文档</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">定制化文档</div>
<div class="paragraph">
<p>创建或编辑 <code>api-docs/asciidoc/index.adoc</code> 加入个性化内容，此为 <code>asciidoc</code> 格式，使用见： <a href="http://asciidoctor.org/docs/asciidoc-writers-guide/" class="bare">http://asciidoctor.org/docs/asciidoc-writers-guide/</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true--22"><a class="anchor" href="#true--22"></a>3.2.3. 数据访问</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:jdbc-example、mybatisplus-example</pre>
</div>
</div>
<div class="paragraph">
<p><code>Dew</code> 基于 <code>Spring Boot</code> ，原生支持 <code>Hibernate</code> <code>MyBatis</code> <code>Spring JDBC Template</code> 等主流的持久化框架。 各类框架的整合参见网络资料，示例中提供了针对 <code>MybatisPlus</code> 的整合说明： <code>mybatisplus</code> 。</p>
</div>
<div class="sect4">
<h5 id="true-code-dew-jdbc-code"><a class="anchor" href="#true-code-dew-jdbc-code"></a><code>Dew JDBC</code></h5>
<div class="paragraph">
<p><code>Dew</code> 选用 <code>Spring JDBC Template</code> 这一轻量的数据处理框架，并做了一定的扩展以支持：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>支持实体与SQL的映射</p>
</li>
<li>
<p>支持常用数据处理操作</p>
</li>
<li>
<p>支持@Select注解</p>
</li>
<li>
<p>轻松使用多数据源</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>JdbcTemplate</code> 知识见 <a href="https://spring.io/guides/gs/relational-data-access/">https://spring.io/guides/gs/relational-data-access/</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
SQL输出日志需要在 <code>logback-spring.xml</code> 中添加 <code>&lt;logger name="org.springframework.jdbc.core" level="TRACE"/&gt;</code>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>启用 <code>Dew JDBC</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
        &lt;artifactId&gt;boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!--引入JDBC依赖--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
        &lt;artifactId&gt;jdbc-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- 对应的数据库JDBC驱动 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.h2database&lt;/groupId&gt;
        &lt;artifactId&gt;h2&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>Dew JDBC</code> 指定使用 <code>druid</code> 做为连接池。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">增加配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
    datasource:
    driver-class-name: # 驱动名
    url: # 驱动url
    druid:
      # 连接池配置</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="true-sql"><a class="anchor" href="#true-sql"></a>实体与SQL的映射</h6>
<div class="paragraph">
<p><code>Dew JDBC</code> 支持注解方式实现ORMPing，可用的注解有:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Entity</code> : 表示此类可映射为数据库表</p>
</li>
<li>
<p><code>PkColumn</code> : 主键标识 支持 <code>int/String</code> 类型，<code>int</code> 多用于ID自增场景， <code>String</code> 可选择是否自动生成 <code>uuid</code> 数据（ <code>uuid=true</code> ），存在此注解的实体可以使用 <code>xxxById</code> 操作</p>
</li>
<li>
<p><code>CodeColumn</code> : 业务主键 在工程中很多对象的主键不依赖于数据库主键而会使用code（如uuid表示）作为业务主键， 保存（insert）时如果存在业务主键，且  <code>value==null &amp;&amp; uuid=true</code> 则会自动附加上uuid，存在此注解的实体可以使用 <code>xxxByCode</code> 操作</p>
</li>
<li>
<p><code>CreateUserColumn</code> : 创建人，保存（insert）时自动附加当前操作人 <code>code</code> （需要与获取操作人动作同一线程）</p>
</li>
<li>
<p><code>CreateTimeColumn</code> : 创建时间，保存（insert）时自动附加当前时间，LocalDateTime类型</p>
</li>
<li>
<p><code>UpdateUserColumn</code> ：更新人，保存（insert）更新（updateById/updateByCode）时自动附加当前操作人 <code>code</code> （需要与获取操作人动作同一线程）</p>
</li>
<li>
<p><code>UpdateTimeColumn</code> : 更新时间，保存（insert）更新（updateById/updateByCode）时自动附加当前时间，LocalDateTime类型</p>
</li>
<li>
<p><code>EnabledColumn</code> : 状态，启用或禁用，支持字段字面含义反转（ <code>reverse=true</code> ） 存在此注解的实体可以使用 <code>enableByXX</code> <code>disableByXX</code> <code>xxEnabled</code> <code>xxDisabled</code> 操作</p>
</li>
<li>
<p><code>Column</code>: 普通字段</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
只有存在<code>Entity</code>注解的类才会被解析，只有存在<code>XXColumn</code>的字段才会被映射。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
为方便操作，框架提供了 <code>PkEntity</code> <code>SafeEntity</code> <code>StatusEntity</code> <code>SafeStatusEntity</code> 四个预制的父类。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">实体与SQL的映射示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Entity
public class Pet implements Serializable {

    @PkColumn
    private int id;
    @Column(notNull = true)
    private String type;
    @Column(notNull = true)
    private BigDecimal price;
    @CreateTimeColumn
    private LocalDateTime createTime;
    @UpdateTimeColumn
    private LocalDateTime updateTime;
    @EnabledColumn
    private boolean enabled;

    // get/set...
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
实体对象需要实现 <code>Serializable</code> 接口。
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="true--23"><a class="anchor" href="#true--23"></a>常用数据处理操作</h6>
<div class="ulist">
<ul>
<li>
<p><strong>增加</strong> <code>Dew.ds().insert(Object entity) / Dew.ds().insert(Iterable&lt;?&gt; entities)</code></p>
</li>
<li>
<p><strong>更新</strong> <code>Dew.ds().updateById(P id, Object entity) / Dew.ds().updateByCode(String code, Object entity)</code></p>
</li>
<li>
<p><strong>获取单条</strong> <code>Dew.ds().getById(P id, Class&lt;E&gt; entityClazz) / Dew.ds().getByCode(String code, Class&lt;E&gt; entityClazz) / Dew.ds().get(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>获取多条</strong> <code>Dew.ds().findAll(Class&lt;E&gt; entityClazz) / Dew.ds().findEnabled(…) / Dew.ds().findDisabled(…) / Dew.ds().find(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>获取分页</strong> <code>Dew.ds().paging(long pageNumber, int pageSize, Class&lt;E&gt; entityClazz) / Dew.ds().pagingEnabled(…) / Dew.ds().pagingDisabled(…) / Dew.ds().paging(SB sqlBuilder, long pageNumber, int pageSize, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>计数</strong> <code>Dew.ds().countAll(Class&lt;?&gt; entityClazz) / Dew.ds().countEnabled(Class&lt;?&gt; entityClazz) / Dew.ds().countDisabled(Class&lt;?&gt; entityClazz) / Dew.ds().count(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>启用</strong> <code>Dew.ds().enableById(P id, Class&lt;?&gt; entityClazz) / Dew.ds().enableByCode(String code, Class&lt;?&gt; entityClazz) / Dew.ds().enable(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>禁用</strong> <code>Dew.ds().disableById(P id, Class&lt;?&gt; entityClazz) / Dew.ds().disableByCode(String code, Class&lt;?&gt; entityClazz) / Dew.ds().disable(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>是否存在</strong> <code>Dew.ds().existById(P id, Class&lt;?&gt; entityClazz) / Dew.ds().existByCode(String code, Class&lt;?&gt; entityClazz) / Dew.ds().exist(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
<li>
<p><strong>物理删除</strong> <code>Dew.ds().deleteById(P id, Class&lt;?&gt; entityClazz) / Dew.ds().deleteByCode(String code, Class&lt;?&gt; entityClazz) / Dew.ds().delete(SB sqlBuilder, Class&lt;E&gt; entityClazz)</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
您可以使用：<code>DewDS)Dew.ds(.jdbc()</code> 获取 <code>JdbcTemplate</code> 原生API。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">常用数据处理操作示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// =============== DS 示例 ===============
// 初始宠物表
((DewDS)Dew.ds()).jdbc().execute("CREATE TABLE pet\n" +
        "(\n" +
        "id int primary key auto_increment,\n" +
        "type varchar(50),\n" +
        "price decimal(11,4) not null,\n" +
        "create_time datetime,\n" +
        "update_time datetime,\n" +
        "enabled bool\n" +
        ")");
// 初始化订单表
((DewDS)Dew.ds()).jdbc().execute("CREATE TABLE t_order\n" +
        "(\n" +
        "id int primary key auto_increment,\n" +
        "pet_id int,\n" +
        "customer_id int,\n" +
        "price decimal(11,4) not null,\n" +
        "create_time datetime \n" +
        ")");

Pet pet = new Pet();
pet.setType("狗");
pet.setPrice(new BigDecimal(1000));
pet.setEnabled(true);
// insert
int id = (int) Dew.ds().insert(pet);
// getById
pet = Dew.ds().getById(id, Pet.class);
assert pet.getType().equals("狗");</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="truesb-sql"><a class="anchor" href="#truesb-sql"></a>SB，SQL构造器</h6>
<div class="paragraph">
<p>每个类型的操作都支持使用SQL构造器构造SQL，目前支持针对单表多条件AND连接的Where条件拼装和排序设置。</p>
</div>
<div class="listingblock">
<div class="title">SB方法</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">SB eq(String field, Object value)
SB notEq(String field, Object value)
SB gt(String field, Object value)
SB ge(String field, Object value)
SB lt(String field, Object value)
SB le(String field, Object value)
SB like(String field, Object value)
SB in(String field, List&lt;Object&gt; values)
SB notIn(String field, List&lt;Object&gt; values)
SB isNull(String field)
SB notNull(String field)
SB between(String field, Object value1, Object value2)
SB asc(String filed)
SB desc(String filed)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">SB示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">DewSB.inst()
   .eq("fieldA", "测试A2")
   .like("fieldB", "%B2")
   .notNull("code")
   .desc("createTime")</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="truedewdao"><a class="anchor" href="#truedewdao"></a>DewDao</h6>
<div class="paragraph">
<p><code>DewDao</code> 是一个泛型基础 <code>Dao</code> 类，实现了常用的操作。</p>
</div>
<div class="paragraph">
<p>上个章节的示例用 <code>DewDao</code> 可写成如下形式：</p>
</div>
<div class="listingblock">
<div class="title">常用数据处理操作示例 <code>DewDao</code> 版</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// 在配置文件中添加Dao的路径
Dew:
  jdbc:
    base-packages: ["com.ecfront.dew.example.jdbc.jdbc"]

// 添加PetDao
public interface PetDao extends DewDao&lt;Integer, Pet&gt; {
}

@Autowired
private PetDao petDao;

// =============== Dao 示例 ===============
// insert by jdbc
pet = new Pet();
pet.setType("猫");
pet.setPrice(new BigDecimal(2000));
pet.setEnabled(true);
id = petDao.insert(pet);
// getById by jdbc
pet = petDao.getById(id);
assert pet.getType().equals("猫");</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="true-select"><a class="anchor" href="#true-select"></a>@Select注解</h6>
<div class="listingblock">
<div class="title"><code>@Select</code> 格式</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Select(value = "&lt;SQL，使用#{参数占位名}&gt;", entityClass = &lt;返回的实体，为空时以Map封装&gt;)
&lt;返回类型，可为单个对象/List/Page&gt; &lt;方法名，java规范即可&gt;(&lt;行参修饰符，@Param(&lt;参数占位名&gt;)或@ModelParam&gt; &lt;行参&gt;);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
方法参数Bean类型需使用 <code>@ModelParam</code> ，参数作为SQL参数需使用 <code>@Param()</code> 并指定与#{}相匹配的名称。
<code>@Select</code> 中entityClass用于指定返回类型。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
分页查询要求返回 <code>Page&lt;?&gt;</code> 对象，参数最后两个固定为 <code>@Param("pageNumber") long pageNumber, @Param("pageSize") int pageSize</code> 这两个参数框架会自行解析，<code>pageNumber</code> 从 <code>1</code> 开始。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>@Select</code> 中默认对 * 和 .* 自动解析成表对应字段，但不支持表的嵌套查询。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>@Select</code> 示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// 返回全量数据
@Select(value = "select * from t_test_crud_s_entity where field_a= #{ fieldA }", entityClass = CRUDSTestEntity.class)
List&lt;CRUDSTestEntity&gt; queryByField(@Param("fieldA") String fieldA);

//返回分页数据
@Select(value = "select * from t_test_crud_s_entity where field_a= #{ fieldA }", entityClass = CRUDSTestEntity.class)
Page&lt;CRUDSTestEntity&gt; queryByCustomPaging(@ModelParam CRUDSTestEntity model, @Param("pageNumber") Long pageNumber, @Param("pageSize") Integer pageSize);

//返回Bean类型数据
@Select(value = "select * from t_test_crud_s_entity where id= #{id}", entityClass = CRUDSTestEntity.class)
CRUDSTestEntity getById(@Param("id") P id);

//返回Map类型数据
@Select(value = "select * from t_test_crud_s_entity where id= #{id}")
Map&lt;String,Object&gt; getMapById(@Param("id") P id);</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">使用限制</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>@Select</code> 只能用于接口、暂不支持DSL SQL，比如（HQL）</p>
</li>
<li>
<p><code>@ModelParam</code> 参数不支持 <code>null</code> 查询</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="true--24"><a class="anchor" href="#true--24"></a>多数据源</h6>
<div class="paragraph">
<p><code>Dew</code> 可以很轻松地实现多数据源使用。</p>
</div>
<div class="listingblock">
<div class="title">多数据源配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
  datasource: # 主数据源配置
    driver-class-name:
    url:
    druid:
      # 主数据源连接池配置
  multi-datasources: # 此key下配置其它数据源
    other: # 数据源标识
      driver-class-name:
      url:
      # 此数据源的连接池配置</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
其它数据源务必配置在 <code>spring.multi-datasources</code> 下，格式是 <code>spring.multi-datasources.&lt;DS Name&gt;.&lt;属性名&gt;=&lt;属性值&gt;</code>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
主数据源连接池要加上 <code>druid</code> 或其它类型，其它数据源与 <code>url</code> 、 <code>username</code> 同级即可。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">多数据源配置 示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:test
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
  multi-datasources:
    other:
      driver-class-name: org.h2.Driver
      url: jdbc:h2:mem:test_other
      initial-size: 1
      max-active: 1</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">多数据源使用</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// =============== 1）Dew.ds上直接使用 ===============

Dew.ds(&lt;数据源标识，为空时表示使用主数据源&gt;).XX

// -------- 例如 --------

// 初始化客户表，来自另一个数据源
((DewDS) Dew.ds("other")).jdbc().execute("CREATE TABLE customer\n" +
        "(\n" +
        "id int primary key auto_increment,\n" +
        "name varchar(50)\n" +
        ")");
Customer customer = new Customer();
customer.setName("张三");
// insert
id = (int) Dew.ds("other").insert(customer);
// getById
customer = Dew.ds("other").getById(id, Customer.class);
assert customer.getName().equals("张三");

// =============== 2）Dao层上使用 ===============

// Dao必须重写 `String ds()` 方法，返回对应的数据源标识

// -------- 例如 --------

public interface CustomerDao extends DewDao&lt;Integer, Customer&gt; {
    @Override
    default String ds() {
        return "other";
    }
}

// =============== 3）直接使用JdbcTemplate ===============

@Qualifier("&lt;数据源标识+JdbcTemplate&gt;")

// -------- 例如 --------

@Autowired // 主数据源
private JdbcTemplate jdbcTemplate;

@Autowired
@Qualifier("otherJdbcTemplate") // 其它数据源
private JdbcTemplate secondaryJdbcTemplate;

// =============== 事务处理 ===============

@Transactional("&lt;数据源标识+TransactionManager，为空表示主数据源&gt;")

// -------- 例如 --------

@Transactional(otherTransactionManager)</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>JdbcTemplate</code> Bean名称规则：主数据源= <code>jdbcTemplate</code> ，其它数据源= <code>&lt;DS Name&gt;JdbcTemplate</code>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<code>TransactionManager</code> Bean名称规则：主数据源= <code>transactionManager</code> ，其它数据源= <code>&lt;DS Name&gt;TransactionManager</code>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true--25"><a class="anchor" href="#true--25"></a>3.2.4. 集群功能</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:cluster-example</pre>
</div>
</div>
<div class="paragraph">
<p><code>Dew</code> 的集群支持 <code>分布式缓存</code> <code>分布式Map</code> <code>分布式锁</code> <code>MQ</code> <code>Leader Election</code>，并且做了接口抽象以适配不同的实现，目前支持 <code>Redis</code> <code>Hazelcast</code> <code>Rabbit</code> <code>Ignite</code> <code>Eureka</code> 。</p>
</div>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--引入集群依赖，可选redis/hazelcast/rabbit/ignite/eureka--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-hazelcast&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-rabbit&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-ignite&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--此实现需要引用 cloud-starter --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-eureka&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">增加配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
    cluster: # 集群功能
        cache: # 缓存实现，默认为 redis
        dist: # 分布式锁和Map实现，默认为 redis，可选 redis/hazelcast
        mq: # MQ实现，默认为 redis，可选 redis/hazelcast/rabbit
        election: # 领导者选举实现，默认为 eureka

spring:
    redis:
        host: # redis主机
        port: # redis端口
        database: # redis数据库
        password: # redis密码
        pool: # 连接池配置
    rabbitmq:
      host: # rabbit主机
      port: # rabbit端口
      username: # rabbit用户名
      password: # rabbit密码
      virtual-host: # rabbit VH
    hazelcast:
        addresses: [] # hazelcast地址，端口可选</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>eureka</code> 实现了领导者选择，必须为 <code>Spring Cloud</code> 工程。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>集群服务的使用入口统一为： <code>Dew.cluster.XX</code></p>
</div>
<div class="sect4">
<h5 id="true--26"><a class="anchor" href="#true--26"></a>分布式缓存</h5>
<div class="listingblock">
<div class="title">MQ服务: <code>Dew.cluster.cache</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * key是否存在
 *
 * @param key key
 * @return 是否存在
 */
boolean exists(String key);

/**
 * 获取字符串值
 *
 * @param key key
 * @return 值
 */
String get(String key);

/**
 * 设置字符串
 *
 * @param key       key
 * @param value     value
 * @param expireSec 过期时间(seconds)，0表示永不过期
 */
void set(String key, String value, int expireSec);

/**
 * 设置字符串
 *
 * @param key   key
 * @param value value
 */
void set(String key, String value);

/**
 * 删除key
 *
 * @param key key
 */
void del(String key);

/**
 * 添加列表值
 *
 * @param key   key
 * @param value value
 */
void lpush(String key, String value);

/**
 * 设置列表
 *
 * @param key       key
 * @param values    values
 * @param expireSec 过期时间(seconds)，0表示永不过期
 */
void lmset(String key, List&lt;String&gt; values, int expireSec);

/**
 * 设置列表
 *
 * @param key    key
 * @param values values
 */
void lmset(String key, List&lt;String&gt; values);

/**
 * 弹出栈顶的列表值
 * 注意，Redis的列表是栈结构，先进后出
 *
 * @param key key
 * @return 栈顶的列表值
 */
String lpop(String key);

/**
 * 获取列表值的长度
 *
 * @param key key
 * @return 长度
 */
long llen(String key);

/**
 * 获取列表中的所有值
 *
 * @param key key
 * @return 值列表
 */
List&lt;String&gt; lget(String key);

/**
 * 设置Hash集合
 *
 * @param key       key
 * @param values    values
 * @param expireSec 过期时间(seconds)，0表示永不过期
 */
void hmset(String key, Map&lt;String, String&gt; values, int expireSec);

/**
 * 设置Hash集合
 *
 * @param key    key
 * @param values values
 */
void hmset(String key, Map&lt;String, String&gt; values);


/**
 * 修改Hash集合field对应的值
 *
 * @param key   key
 * @param field field
 * @param value value
 */
void hset(String key, String field, String value);

/**
 * 获取Hash集合field对应的值
 *
 * @param key   key
 * @param field field
 * @return field对应的值
 */
String hget(String key, String field);

/**
 * 判断Hash集合field是否存在
 *
 * @param key   key
 * @param field field
 * @return 是否存在
 */
boolean hexists(String key, String field);

/**
 * 获取Hash集合的所有值
 *
 * @param key key
 * @return 所有值
 */
Map&lt;String, String&gt; hgetAll(String key);

/**
 * 删除Hash集合是对应的field
 *
 * @param key   key
 * @param field field
 */
void hdel(String key, String field);

/**
 * 原子加操作
 *
 * @param key       key，key不存在时会自动创建值为0的对象
 * @param incrValue 要增加的值，必须是Long Int Float 或 Double
 * @return 操作后的值
 */
long incrBy(String key, long incrValue);

/**
 * 原子减操作
 *
 * @param key       key不存在时会自动创建值为0的对象
 * @param decrValue 要减少的值，必须是Long  或 Int
 * @return 操作后的值
 */
long decrBy(String key, long decrValue);

/**
 * 设置过期时间
 *
 * @param key       key
 * @param expireSec 过期时间(seconds)，0表示永不过期
 */
void expire(String key, int expireSec);

void flushdb();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Cache示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">Dew.cluster.cache.flushdb();
Dew.cluster.cache.del("n_test");
assert !Dew.cluster.cache.exists("n_test");
Dew.cluster.cache.set("n_test", "{\"name\":\"jzy\"}", 1);
assert Dew.cluster.cache.exists("n_test");
assert "jzy".equals($.json.toJson(Dew.cluster.cache.get("n_test")).get("name").asText());
Thread.sleep(1000);
assert !Dew.cluster.cache.exists("n_test");
assert null == Dew.cluster.cache.get("n_test");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true--27"><a class="anchor" href="#true--27"></a>分布式锁</h5>
<div class="listingblock">
<div class="title">MQ服务: <code>Dew.cluster.dist.lock</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * 加锁，加锁成功后执行对应的函数，执行完成自动解锁
 * &lt;p&gt;
 * 推荐使用 {@link #tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun)}
 *
 * @param fun 加锁成功后执行的函数
 */
void lockWithFun(VoidProcessFun fun) throws Exception;

/**
 * 尝试加锁，加锁成功后执行对应的函数，执行完成自动解锁
 * &lt;p&gt;
 * 推荐使用 {@link #tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun)}
 *
 * @param fun 加锁成功后执行的函数
 */
void tryLockWithFun(VoidProcessFun fun) throws Exception;

/**
 * 尝试加锁，加锁成功后执行对应的函数，执行完成自动解锁
 * &lt;p&gt;
 * 推荐使用 {@link #tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun)}
 *
 * @param fun 加锁成功后执行的函数
 */
void tryLockWithFun(long waitMillSec, VoidProcessFun fun) throws Exception;

/**
 * 尝试加锁，加锁成功后执行对应的函数，执行完成自动解锁
 *
 * @param waitMillSec  等待毫秒数
 * @param leaseMillSec 锁释放毫秒数
 * @param fun          加锁成功后执行的函数
 */
void tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun) throws Exception;

/**
 * 加锁
 * &lt;p&gt;
 * 推荐使用 {@link #tryLock(long waitMillSec, long leaseMillSec)}
 */
void lock();

/**
 * 尝试加锁
 * &lt;p&gt;
 * 推荐使用 {@link #tryLock(long waitMillSec, long leaseMillSec)}
 */
boolean tryLock();

/**
 * 尝试加锁
 * &lt;p&gt;
 * 推荐使用 {@link #tryLock(long waitMillSec, long leaseMillSec)}
 *
 * @param waitMillSec 等待毫秒数
 */
boolean tryLock(long waitMillSec) throws InterruptedException;

/**
 * 尝试加锁
 *
 * @param waitMillSec  等待毫秒数
 * @param leaseMillSec 锁释放毫秒数
 */
boolean tryLock(long waitMillSec, long leaseMillSec) throws InterruptedException;

/**
 * 解锁操作，只有加锁的实例及线程才能解锁
 */
boolean unLock();

/**
 * 强制解锁，不用匹配加锁的实例与线程
 * &lt;p&gt;
 * 谨慎使用
 */
void delete();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Lock示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// dist lock
ClusterDistLock lock = Dew.cluster.dist.lock("test_lock");
// tryLock 示例，等待0ms，忘了手工unLock或出异常时1s后自动解锁
if (lock.tryLock(0, 1000)) {
    try {
        // 已加锁，执行业务方法
    } finally {
        // 必须手工解锁
        lock.unLock();
    }
}
// tryLockWithFun 示例
lock.tryLockWithFun(0, 1000, () -&gt; {
    // 已加锁，执行业务方法，tryLockWithFun会将业务方法包裹在try-cache中，无需手工解锁
});</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true-map"><a class="anchor" href="#true-map"></a>分布式Map</h5>
<div class="listingblock">
<div class="title">MQ服务: <code>Dew.cluster.dist.map</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * 添加Item，同步实现
 *
 * @param key   key
 * @param value value
 */
void put(String key, M value);

/**
 * 添加Item，异步实现
 *
 * @param key   key
 * @param value value
 */
void putAsync(String key, M value);

/**
 * 添加不存在的Item，同步实现
 *
 * @param key   key
 * @param value value
 */
void putIfAbsent(String key, M value);

/**
 * 指定Key是否存在
 *
 * @param key key
 * @return 是否存在
 */
boolean containsKey(String key);

/**
 * 获取所有Item
 *
 * @return 所有Item
 */
Map&lt;String, M&gt; getAll();

/**
 * 获取指定key的value
 *
 * @param key key
 * @return 对应的value
 */
M get(String key);

/**
 * 删除指定key的Item，同步实现
 *
 * @param key key
 */
void remove(String key);

/**
 * 删除指定key的Item，异步实现
 *
 * @param key key
 */
void removeAsync(String key);

/**
 * 清空Map
 */
void clear();

/**
 * 注册新增Item时要执行的函数
 * &lt;p&gt;
 * 目前只支持Hazelcast实现
 *
 * @param fun 执行的函数
 */
ClusterDistMap&lt;M&gt; regEntryAddedEvent(Consumer&lt;EntryEvent&lt;M&gt;&gt; fun);

/**
 * 注册删除Item时要执行的函数
 * &lt;p&gt;
 * 目前只支持Hazelcast实现
 *
 * @param fun 执行的函数
 */
ClusterDistMap&lt;M&gt; regEntryRemovedEvent(Consumer&lt;EntryEvent&lt;M&gt;&gt; fun);

/**
 * 注册更新Item时要执行的函数
 * &lt;p&gt;
 * 目前只支持Hazelcast实现
 *
 * @param fun 执行的函数
 */
ClusterDistMap&lt;M&gt; regEntryUpdatedEvent(Consumer&lt;EntryEvent&lt;M&gt;&gt; fun);

/**
 * 注册清空Map时要执行的函数
 * &lt;p&gt;
 * 目前只支持Hazelcast实现
 *
 * @param fun 执行的函数
 */
ClusterDistMap&lt;M&gt; regMapClearedEvent(VoidProcessFun fun);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Map示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">ClusterDistMap&lt;TestMapObj&gt; mapObj = Dew.cluster.dist.map("test_obj_map", TestMapObj.class);
mapObj.clear();
TestMapObj obj = new TestMapObj();
obj.a = "测试";
mapObj.put("test", obj);
assert "测试".equals(mapObj.get("test").a);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="truemq"><a class="anchor" href="#truemq"></a>MQ</h5>
<div class="listingblock">
<div class="title">MQ服务: <code>Dew.cluster.mq</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * MQ 发布订阅模式 之 发布
 *
 * 请确保发布之前 topic 已经存在
 *
 * @param topic   主题
 * @param message 消息内容
 * @return 是否发布成功，此返回值仅在rabbit confirm 模式下才能保证严格准确！
 */
boolean publish(String topic, String message);

/**
 * MQ 发布订阅模式 之 订阅
 *
 * 非阻塞方式
 *
 * @param topic    主题
 * @param consumer 订阅处理方法
 */
void subscribe(String topic, Consumer&lt;String&gt; consumer);

/**
 * MQ 请求响应模式 之 请求
 *
 * @param address 请求地址
 * @param message 消息内容
 * @return 是否请求成功
 */
boolean request(String address, String message);

/**
 * MQ 请求响应模式 之 响应
 *
 * 非阻塞方式
 *
 * @param address  请求对应的地址
 * @param consumer 响应处理方法
 */
void response(String address, Consumer&lt;String&gt; consumer);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">MQ示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// pub-sub
Dew.cluster.mq.subscribe("test_pub_sub", message -&gt;
        logger.info("pub_sub&gt;&gt;" + message));
Thread.sleep(1000);
Dew.cluster.mq.publish("test_pub_sub", "msgA");
Dew.cluster.mq.publish("test_pub_sub", "msgB");
// req-resp
Dew.cluster.mq.response("test_rep_resp", message -&gt;
        logger.info("req_resp&gt;&gt;" + message));
Dew.cluster.mq.request("test_rep_resp", "msg1");
Dew.cluster.mq.request("test_rep_resp", "msg2");
// rabbit confirm
if (Dew.cluster.mq instanceof RabbitClusterMQ) {
    boolean success = ((RabbitClusterMQ) Dew.cluster.mq).publish("test_pub_sub", "confirm message", true);
    success = ((RabbitClusterMQ) Dew.cluster.mq).request("test_rep_resp", "confirm message", true);
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
发布订阅模式时，发布前 <code>topic</code> 必须已经存在，可先使用 <code>subscribe</code> 订阅，此操作会自动创建 <code>topic</code> 。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>rabbit</code> 实现支持单条 <code>confirm</code> 模式。
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="trueleader-election"><a class="anchor" href="#trueleader-election"></a>Leader Election</h5>
<div class="listingblock">
<div class="title">MQ服务: <code>Dew.cluster.election</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * 执行（重新）选举
 *
 * 需调用方定时调用此接口
 *
 * @throws Exception
 */
void election() throws Exception;

/**
 * 退出选举，暂未实现
 * @throws Exception
 */
void quit() throws Exception;

/**
 * 当前工程是否是领导者
 * @return 是否是领导者
 */
boolean isLeader();</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">SPI选型</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Redis: 多用于Cache，可做为轻量MQ，可用于要求不高的Lock(Redis锁存在不安全隐患)及Map</p>
</li>
<li>
<p>Hazelcast: 对Lock及Map支持得很好，可做为轻量MQ</p>
</li>
<li>
<p>Rabbit: 仅做MQ用，支持持久化，支持仅在收到消息并且处理完成后才Acknowledge</p>
</li>
<li>
<p>Eureka: 可用集群选举</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Rabbit Confirm模式支持</div>
<div class="paragraph">
<p>((RabbitClusterMQ)Dew.cluster.mq).publish(String topic, String message, boolean confirm)<br>
((RabbitClusterMQ)Dew.cluster.mq).request(String address, String message, boolean confirm)</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--28"><a class="anchor" href="#true--28"></a>3.3. 增强</h3>
<div class="sect3">
<h4 id="true--29"><a class="anchor" href="#true--29"></a>3.3.1. 服务脚手架</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:guide-petstore</pre>
</div>
</div>
<div class="paragraph">
<p>一般的，我们对实体对象的操作可以有 <code>增C删D改U查R</code> 外加<code>状态变更S</code>，<code>服务脚手架</code>从<code>DAO</code>到<code>Service</code>再到<code>Controller</code>实现了上述操作。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CRUController: 支持增改查操作</p>
</li>
<li>
<p>CRUDController: 支持增删改查操作</p>
</li>
<li>
<p>CRUSController: 支持增改查状态变更操作</p>
</li>
<li>
<p>CRUDSController: 支持增删改查状态变更操作</p>
</li>
<li>
<p>CRUVOController: 支持增改查操作（带VO-Entity转换）</p>
</li>
<li>
<p>CRUSVOController: 支持增删改查操作（带VO-Entity转换）</p>
</li>
<li>
<p>CRUDVOController: 支持增改查状态变更操作（带VO-Entity转换）</p>
</li>
<li>
<p>CRUDSVOController: 支持增删改查状态变更操作（带VO-Entity转换）</p>
</li>
<li>
<p>CRUService: 支持增改查操作</p>
</li>
<li>
<p>CRUDService: 支持增删改查操作</p>
</li>
<li>
<p>CRUSService: 支持增改查状态变更操作</p>
</li>
<li>
<p>CRUDSService: 支持增删改查状态变更操作</p>
</li>
<li>
<p>DewDao: 支持增删改查状态变更操作</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
详见API文档。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
脚本架方法不带缓存，如需要缓存请在子类复写对应的方法。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
目前服务脚手架需与 <code>Dew JDBC</code> 配合使用，后期会适配其它持久化框架。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="true--30"><a class="anchor" href="#true--30"></a>3.3.2. 权限认证</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:auth-example</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Dew 内核不支持鉴权处理（Auth组件），现支持两种模式</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>basic模式，它支持<code>认证缓存</code>，即支持将鉴权系统生成的登录信息缓存到业务系统中方便即时调用。</p>
</li>
<li>
<p>csp模式，支持用户中心权限系统</p>
</li>
</ol>
</div>
</blockquote>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>basic模式</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">配置认证缓存</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
    security:
        token-flag: # token key的名称
        token-in-header: # token key是否在http header中，为false是会从url query中获取
        token-hash: # token 值是否做hash（MD5）处理</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
认证缓存需要 <code>集群缓存</code> 服务支持，请引入相关的依赖并配置对应的连接信息等。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">basic 认证缓存接口</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// 添加登录信息，optInfo封装自鉴权系统过来的登录信息
// 一般在登录认证后操作
Dew.auth.setOptInfo(OptInfo optInfo);
// 获取登录信息，要求在http请求加上token信息
Dew.context().optInfo();
// 删除登录信息
// 一般在注销登录后操作
Dew.auth.removeOptInfo();

// 登录信息
public class OptInfo {
    // Token
    String token;
    // 账号编码
    String accountCode;
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>OptInfo</code> 为认证缓存信息的基类，使用时可以继承并扩展自己的属性。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
使用 <code>OptInfo</code> 扩展类型时需要在工程启动时指定扩展类： <code>DewContext.setOptInfoClazz(&lt;扩展类型&gt;)</code> 。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">basic 认证缓存示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">/**
 * 模拟用户注册
 */
@PostMapping(value = "user/register")
public Resp&lt;Void&gt; register(@RequestBody User user) {
    // 实际注册处理
    user.setId($.field.createUUID());
    MOCK_USER_CONTAINER.put(user.getId(), user);
    return Resp.success(null);
}

/**
 * 模拟用户登录
 */
@PostMapping(value = "auth/login")
public Resp&lt;String&gt; login(@RequestBody LoginDTO loginDTO) {
    // 实际登录处理
    User user = MOCK_USER_CONTAINER.values().stream().filter(u -&gt; u.getIdCard().equals(loginDTO.getIdCard())).findFirst().get();
    String token = $.field.createUUID();
    Dew.auth.setOptInfo(new OptInfoExt()
            .setIdCard(user.getIdCard())
            .setAccountCode($.field.createShortUUID())
            .setToken(token)
            .setName(user.getName())
            .setMobile(user.getPhone()));
    return Resp.success(token);
}

/**
 * 模拟业务操作
 */
@GetMapping(value = "business/someopt")
public Resp&lt;Void&gt; someOpt() {
    // 获取登录用户信息
    Optional&lt;OptInfoExt&gt; optInfoExtOpt = Dew.auth.getOptInfo();
    if (!optInfoExtOpt.isPresent()) {
        return Resp.unAuthorized("用户认证错误");
    }
    // 登录用户的信息
    optInfoExtOpt.get();
    return Resp.success(null);
}

/**
 * 模拟用户注销
 */
@DeleteMapping(value = "auth/logout")
public Resp&lt;Void&gt; logout() {
    // 实际注册处理
    Dew.auth.removeOptInfo();
    return Resp.success(null);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>csp模式</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
增加csp-starter依赖，则强制权限认证采用csp模式
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
csp模式使用CSPOptInfo对象基类
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">pom.xml依赖配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
          &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
          &lt;artifactId&gt;csp-starter&lt;/artifactId&gt;
 &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">csp模式配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
    security:
        auth:
            csp:
                party-id: #partyId在header中的key值 默认为'X-User-Id'
                app-id: #appId在header中的key值 默认为'X-App-Id'
                roles: #角色在header中的key值 默认为'X-Roles'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">csp模式接口</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">// 添加登录信息，optInfo封装自鉴权系统过来的登录信息
// 一般在登录认证后操作
Dew.auth.setOptInfo(OptInfo optInfo);// 框架自动加载
// 获取登录信息，要求在http请求加上token，appId,roles
Dew.context().optInfo();//
// 删除登录信息
// 一般在注销登录后操作（无需手动操作）
Dew.auth.removeOptInfo();

// 登录信息
public class OptInfo&lt;E&gt; {
    // Token
    String token;
    // 账号编码
    String accountCode;
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>OptInfo</code> 为认证缓存信息的基类，使用时可以继承并扩展自己的属性。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
使用 <code>OptInfo</code> 扩展类型时需要在工程启动时指定扩展类： <code>DewContext.setOptInfoClazz(&lt;扩展类型&gt;)</code> 。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">csp模式示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">    /**
     * 模拟业务操作
     */
    @GetMapping(value = "business/someopt")
    public Resp&lt;Void&gt; someOpt() {
        // 获取登录用户信息
        Optional&lt;CSPOptInfo&gt; optInfoExtOpt = Dew.auth.getOptInfo();
        if (!optInfoExtOpt.isPresent()) {
            return Resp.unAuthorized("用户认证错误");
        }
        // 登录用户的信息
        optInfoExtOpt.get();
        return Resp.success(null);
    }

    /**
     * 模拟用户注销
     */
    @DeleteMapping(value = "auth/logout")
    public Resp&lt;Void&gt; logout() {
        // 实际注册处理
        Dew.auth.removeOptInfo();
        return Resp.success(null);
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true--31"><a class="anchor" href="#true--31"></a>3.3.3. 追踪日志</h4>
<div class="paragraph">
<p><code>Dew</code> 集成了可追踪日志的功能，本质上一个 <code>slf4j</code> 的装饰器，会在每条日志内容前面打印 <code>用户账号 #</code> 。</p>
</div>
<div class="listingblock">
<div class="title">使用方式</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">Logger logger = DewLogger.getLogger(&lt;当前的class&gt;);
logger.info/debug/trace/error...</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
此功能要求使用 <code>Threadlocal</code> 与请求接收同一线程有效，不同线程需要把 <code>DewContext</code> 传入到新线程并执行执行 <code>DewContext.setContext(context)</code> 。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truedubbo"><a class="anchor" href="#truedubbo"></a>3.3.4. Dubbo兼容</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:dubbo-example</pre>
</div>
</div>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.dubbo.springboot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-dubbo&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
    &lt;exclusions&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j&lt;/artifactId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
        &lt;/exclusion&gt;
    &lt;/exclusions&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>配置与使用</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dubbo官方发行版本无法处理存在声明式事务的服务，简单的解决方案是：</p>
</div>
<div class="listingblock">
<div class="title">添加com.alibaba.dubbo.config.annotation.Service到工程</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package com.alibaba.dubbo.config.annotation;

import java.lang.annotation.*;

/**
 * 添加@Inherited，修正带声明式事务的服务提供问题
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
@Inherited
public @interface Service {

    Class&lt;?&gt; interfaceClass() default void.class;

    String interfaceName() default "";

    String version() default "";

    String group() default "";

    String path() default "";

    boolean export() default false;

    String token() default "";

    boolean deprecated() default false;

    boolean dynamic() default false;

    String accesslog() default "";

    int executes() default 0;

    boolean register() default false;

    int weight() default 0;

    String document() default "";

    int delay() default 0;

    String local() default "";

    String stub() default "";

    String cluster() default "";

    String proxy() default "";

    int connections() default 0;

    int callbacks() default 0;

    String onconnect() default "";

    String ondisconnect() default "";

    String owner() default "";

    String layer() default "";

    int retries() default 0;

    String loadbalance() default "";

    boolean async() default false;

    int actives() default 0;

    boolean sent() default false;

    String mock() default "";

    String validation() default "";

    int timeout() default 0;

    String cache() default "";

    String[] filter() default {};

    String[] listener() default {};

    String[] parameters() default {};

    String application() default "";

    String module() default "";

    String provider() default "";

    String[] protocol() default {};

    String monitor() default "";

    String[] registry() default {};
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">在带声明式事务的类显示声明 <code>interfaceName</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Service(version = "",interfaceName = "")</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truesharding-jdbc"><a class="anchor" href="#truesharding-jdbc"></a>3.3.5. sharding-jdbc集成</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
sharding-jdbc官网 <a href="https://github.com/shardingjdbc" class="bare">https://github.com/shardingjdbc</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
dew里有两个分库分表策略模版(DewIntegerShardingAlgorithm,DewLongShardingAlgorithm)，各团队在使用时可直接使用，或参考模版自行配置
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
sharding-jdbc的2.0.0.M1版本源码存在问题，反射获取方法时存在bug，不支持druid连接池，暂时还不建议使用
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>sharding-jdbc</code>在<code>/resources/META-INF/</code>下的配置文件示例，该示例为分库分表+读写分离</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">sharding:
  jdbc:
    dataSource:
      names: ds_master_0,ds_master_1,ds_master_0_slave_0,ds_master_0_slave_1,ds_master_1_slave_0,ds_master_1_slave_1
      ds_master_0:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/demo_ds_master_0
        username: root
        password: 123456
      ds_master_0_slave_0:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/demo_ds_master_0_slave_0
        username: root
        password: 123456
      ds_master_0_slave_1:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/demo_ds_master_0_slave_1
        username: root
        password: 123456
      ds_master_1:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/demo_ds_master_1
        username: root
        password: 123456
      ds_master_1_slave_0:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/demo_ds_master_1_slave_0
        username: root
        password: 123456
      ds_master_1_slave_1:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/demo_ds_master_1_slave_1
        username: root
        password: 123456

    config:
      sharding:
        tables:
          t_order:
            actualDataNodes: ds_${0..1}.t_order_${0..1}
            tableStrategy:
              inline:
                shardingColumn: order_id
                algorithmInlineExpression: t_order_${order_id % 2}
          t_order_item:
            actualDataNodes: ds_${0..1}.t_order_item_${0..1}
            tableStrategy:
              inline:
                shardingColumn: order_id
                algorithmInlineExpression: t_order_item_${order_id % 2}
        #默认数据库分片策略
        defaultDatabaseStrategy:
          inline:
            shardingColumn: user_id
            algorithmInlineExpression: ds_${user_id.longValue() % 2}
        masterSlaveRules:
          ds_0:
            masterDataSourceName: ds_master_0
            slaveDataSourceNames: [ds_master_0_slave_0, ds_master_0_slave_1]
          ds_1:
            masterDataSourceName: ds_master_1
            slaveDataSourceNames: [ds_master_1_slave_0, ds_master_1_slave_1]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
inline写法在2.0.0.M1之后被废除。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">所有策略配置方式</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">tables: #分库分表配置，可配置多个logic_table_name
    able_name: #逻辑表名
        actualDataNodes: #真实数据节点，由库名 + 表名组成，以小数点分隔。多个表以逗号分隔，支持inline表达式。不填写表示为只分库不分表。
        databaseStrategy: #分库策略，以下的分片策略只能任选其一
            standard: #标准分片策略，用于单分片键的场景
                shardingColumn: #分片列名
                preciseAlgorithmClassName: #精确的分片算法类名称，用于=和IN。该类需使用默认的构造器或者提供无参数的构造器
                rangeAlgorithmClassName: #范围的分片算法类名称，用于BETWEEN，可以不配置。该类需使用默认的构造器或者提供无参数的构造器
            complex: #复合分片策略，用于多分片键的场景
                shardingColumns : #分片列名，多个列以逗号分隔
                algorithmClassName: #分片算法类名称。该类需使用默认的构造器或者提供无参数的构造器
            inline: #inline表达式分片策略
                shardingColumn : #分片列名
                algorithmInlineExpression: #分库算法表达式，需要符合groovy动态语法
            hint: #Hint分片策略
                algorithmClassName: #分片算法类名称。该类需使用默认的构造器或者提供无参数的构造器
            none: #不分片
        tableStrategy: #分表策略，同分库策略</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true--32"><a class="anchor" href="#true--32"></a>3.3.6. 幂等支持</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:idempotent-example</pre>
</div>
</div>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;!--引入幂等支持--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;idempotent-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--使用幂等的Redis实现--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-redis&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
  cluster:
    cache: redis # 启用Redis支持
  idempotent:
    default-expire-ms: 3600000 # 设置默认过期时间，1小时
    default-strategy: item # 设置默认策略，支持 bloom(Bloom Filter)和item(逐条记录)
    opt-type-flag: __IDEMPOTENT_OPT_TYPE__ # 指定幂等操作类型标识，可以位于HTTP Header或请求参数中
    opt-id-flag: __IDEMPOTENT_OPT_ID__ # 指定幂等操作ID标识，可以位于HTTP Header或请求参数中</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>使用</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>支持HTTP和非HTTP幂等操作，对于HTTP操作，要求请求方在请求头或URL参数中加上操作类型和操作ID标识，非HTTP操作由可自由指定操作类型和操作ID标识的来源。</p>
</div>
<div class="listingblock">
<div class="title">HTTP操作</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@GetMapping(xxx)
// 启用幂等支持
// 请求头部或参数加上 __IDEMPOTENT_OPT_TYPE__ = xx , __IDEMPOTENT_OPT_ID__ = yy
@Idempotent(expireMs = 5000)
public void test(xxx) {
    // 业务操作
    // ...
    // 业务失败，在保证业务操作的原子性的情况下，在catch中取消幂等，并抛出异常
    DewIdempotent.cancel();
    // 手工确认
    DewIdempotent.confirm();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Idempotent</code>注解说明：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>optTypeFlag：指定幂等操作类型标识，可以位于HTTP Header或请求参数中，要求全局唯一</p>
</li>
<li>
<p>optIdFlag：指定幂等操作ID标识，可以位于HTTP Header或请求参数中</p>
</li>
<li>
<p>expireMs：设置过期时间，单位毫秒</p>
</li>
<li>
<p>strategy：设置默认策略</p>
</li>
<li>
<p>needConfirm：设置是否需要显式确认，true时，需要进行显式确认操作: <code>DewIdempotent.confirm() 或 DewIdempotent.confirm(String optType, String optId)</code> 前者要求与请求入口在同一线程中</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">取消幂等与http操作时的使用方式相同</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public void init() {
    // 初始化用到的操作类型
    // * DewIdempotent.initOptTypeInfo 参数：
    // * @param optType     操作类型
    // * @param needConfirm 是否需要显式确认
    // * @param expireMs    过期时间
    // * @param strategy    策略类型
    DewIdempotent.initOptTypeInfo("transfer_a", true, 1000, StrategyEnum.ITEM);
}

public void send() {
    // 调用
    transferAReceive("xxxx");
}

public void transferAReceive(String id) {
    // 收到请求后先调用process
    // * DewIdempotent.process 参数：
    // * @param optType 操作类型
    // * @param optId   操作ID
    switch (DewIdempotent.process("transfer_a", id)) {
        case NOT_EXIST:
            // 业务操作
            // ...
            // 手工确认
            // * DewIdempotent.confirm 参数：
            // * @param optType 操作类型
            // * @param optId   操作ID
            DewIdempotent.confirm();
        case UN_CONFIRM:
            // 已收到但操作还未确认
            // 对应的处理，一般返回请求等待，稍后重试
        case CONFIRMED:
            // 已确认操作
            // 对应的处理，一般直接返回失败
        default:
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--33"><a class="anchor" href="#true--33"></a>3.4. 工程化</h3>
<div class="sect3">
<h4 id="true--34"><a class="anchor" href="#true--34"></a>3.4.1. 代码质量检查</h4>
<div class="paragraph">
<p>Dew 已集成 <code>Sonar</code> 插件，只需要在maven中配置 <code>sonar.host.url</code> 为目标地址，然后执行 <code>mvn clean verify sonar:sonar -P qa</code> 即可。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如提供没有权限访问，请设置 <code>sonar.forceAuthentication=false</code> 。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
使用 <code>&lt;maven.test.skip&gt;true&lt;/maven.test.skip&gt;</code> 可跳过特定模块的测试，<code>&lt;sonar.skip&gt;true&lt;/sonar.skip&gt;</code> 可跳过特定模块的Sonar检查。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="true--35"><a class="anchor" href="#true--35"></a>3.4.2. 测试支持</h4>
<div class="paragraph">
<p>良好的单元测试可以保证代码的高质量，单测的重要原则是内聚、无依赖，好的单测应该是"函数化"的——结果的变化只与传入参数有关。
但实际上我们会的代码往往会与数据库、缓存、MQ等外部工具交互，这会使单测的结果不可控，通常的解决方案是使用Mock，但这无行中引入了单测撰写的成本，
Dew使用"内嵌式"工具解决，数据库使用 <code>H2</code> ，Redis使用 <code>embedded redis</code> ，由于 <code>Dew</code> 集群的 <code>Cache</code> <code>Map</code> <code>Lock</code> <code>MQ</code> 都支持 <code>Redis</code> 实现，所以可以做到对主流操作的全覆盖。</p>
</div>
<div class="listingblock">
<div class="title">配置示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml"># maven
&lt;dependency&gt;
    &lt;groupId&gt;com.ecfront.dew&lt;/groupId&gt;
    &lt;artifactId&gt;test-starter&lt;/artifactId&gt;
&lt;/dependency&gt;

# config
dew:
  cluster: #所有集群操作都使用reids模拟
    cache: redis
    dist: redis
    mq: redis

spring:
  redis:
    host: 127.0.0.1
    port: 6379
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:test</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true-code-spring-admin-code"><a class="anchor" href="#true-code-spring-admin-code"></a>3.4.3. <code>Spring Admin</code> 集成</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:monitor-example</pre>
</div>
</div>
<div class="paragraph">
<p><code>Dew</code> 集成了 <code>Spring Admin</code> ，封装成 <code>monitor</code> 组件， 示例 <code>monitor-example</code> 演示了如何与 <code>monitor</code> 交互。</p>
</div>
<div class="listingblock">
<div class="title"><code>monitor</code> 关键配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
  application:
    name: monitor # 监控服务名称
  boot:
    admin:
      routes:
        endpoints: env,metrics,dump,jolokia,info,configprops,trace,logfile,refresh,flyway,liquibase,heapdump,loggers,auditevents,hystrix.stream # 要统计的内容
      turbine: # turbine集成配置
        clusters: default # 集群名称
        location: monitor # 聚合到的服务名称，这里要与 `spring.application.name` 相同

turbine: # turbine配置
  aggregator:
    clusterConfig: default # 集群名称
  appConfig: monitor-example # 要聚合的服务名称，需要把各个服务添加上去
  clusterNameExpression: metadata['cluster']

server:
  port: # 端口号

eureka:
  client:
    serviceUrl:
      defaultZone: # eureka 服务地址</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">要监控的服务 关键配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">spring:
  application:
    name: monitor-example # 服务名称，必须在上文 `turbine.appConfig` 添加上去

eureka:
  client:
    serviceUrl: # eureka 服务地址，必须和监控服务在同一集群中
  instance:
    metadata-map:
      cluster: default # 集群名称

management.security.enabled: false # 需要关闭安全管理，可通过IP来限制</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true--36"><a class="anchor" href="#true--36"></a>3.4.4. 服务调用开发期优化</h4>
<div class="paragraph">
<p>在Spring Cloud体系下，服务调用需要启动<code>Eureka</code>服务（对于Dew中的<code>Regstry</code>组件），这对开发阶段并不友好：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>开发期间会不断启停服务，<code>Eureka</code> 保护机制会影响服务注册（当然这是可以关闭的）</p>
</li>
<li>
<p>多人协作时可能会出现调用到他人服务的情况（同一服务多个实例）</p>
</li>
<li>
<p>需要启动 <code>Eureka</code> 服务，多了一个依赖</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>为解决上述问题，Dew框架做了相应的优化，
在服务调用时使用 <code>Dew.EB.post/get/put/delete/options/head</code> 方法，Dew会根据传入的 <code>URL</code> 判断，
如果是 <code>IPv4</code> 则直接调用服务，否则使用Spring Cloud的 <code>RestTemplate</code> 调用。
所以您只需要把服务url做成配置，开发时使用 <code>ip</code> ，测试/生产时使用 <code>service-id</code> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="true-code-hystrix-code"><a class="anchor" href="#true-code-hystrix-code"></a>3.4.5. <code>hystrix</code> 降级增加邮件通知</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
此为 <code>cloud-starter</code> 特性
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>此章节关联 `hystrix-feign-example` 示例</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
为能更及时的对服务异常做出处理， <code>dew</code> 增加邮件通知功能。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml"># 通知条件配置示例
dew:
  cloud:
    error:
      notify-interval-sec: 1800
      notify-emails: 71964899@qq.com
      notify-event-types: FAILURE,SHORT_CIRCUITED,TIMEOUT,THREAD_POOL_REJECTED,SEMAPHORE_REJECTED
      notify-include-keys: ["ExampleClient#deleteExe(int,String)","ExampleClient#postExe(int,String)"]

# 邮箱配置示例
spring:
  mail:
    host: smtp.163.com
    username: &lt;邮件地址&gt;
    password: &lt;password为smtp授权码，非邮箱密码&gt;
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true-code-api-code"><a class="anchor" href="#true-code-api-code"></a>3.4.6. <code>服务API调用</code> （追踪）日志处理</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
此为 <code>cloud-starter</code> 特性
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>此章节关联 `sleuth-invokeX-example` 示例</pre>
</div>
</div>
<div class="paragraph">
<p>用于记录 <code>服务API调用</code> （追踪）日志到 <code>Slf4j</code>。</p>
</div>
<div class="listingblock">
<div class="title">开启追踪日志</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew:
  cloud:
    trace-log:
        enabled: true # 默认为true</code></pre>
</div>
</div>
<div class="paragraph">
<p>之后可选择 <code>ELK</code> 方案，或是 <code>Dew</code> 推荐的 <code>EK</code> 方案（跳过 <code>Logstash</code>，直接向 <code>ES</code> 提交）</p>
</div>
<div class="paragraph">
<p>一次调用日志的查看，以 <code>ES</code> 为例，过滤条件是: logger:com.ecfront.dew.core.logger.DewTraceLogWrap &amp; trace:&lt;对应的traceID&gt;</p>
</div>
</div>
<div class="sect3">
<h4 id="truetps"><a class="anchor" href="#truetps"></a>3.4.7. TPS查询接口</h4>
<div class="paragraph">
<p>基于<code>Spring Boot Actuator</code>提供的metrics接口，dew增加了三个TPS指标，最大响应时间，平均响应时间，90%的响应时间。</p>
</div>
<div class="listingblock">
<div class="title">需要配置如下</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml"># 启用metrics接口
endpoints:
  metrics:
    enabled: true

# spring默认该接口需要security拦截，否则会提示``Unauthorized``，加以下配置即可
management:
  security:
    enabled: false

# 指定统计周期（多少秒内的指标统计）
dew:
  metric:
    period-sec: # 默认600s(10分钟),（单位秒）</code></pre>
</div>
</div>
<div class="paragraph">
<p>开发者可以get请求访问根路径下的/metrics接口，即可看到新增的 <code>dew.response.nityPercent</code>,<code>dew.response.average</code>,<code>dew.response.max</code>,<code>dew.response.tps</code> 四个指标
及针对接口的对应指标</p>
</div>
</div>
<div class="sect3">
<h4 id="truedew-2"><a class="anchor" href="#truedew-2"></a>3.4.8. Dew 启动类配置多样性</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>dew</code>启动类支持注解式配置和继承式配置，注解为<code>@DewBootApplication</code>和<code>@DewCloudApplication</code>,抽象类为<code>DewBootApplication</code>和<code>DewCloudApplication</code>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>注解式配置</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
注解式配置必须详细配置扫描基类
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">在启动类上加@DewBootApplication注解</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@DewBootApplication(scanBasePackageClasses = {Dew.class, ExampleApplication.class})
public class ExampleApplication {

    public static void main(String[] args) throws InterruptedException {
        new SpringApplicationBuilder(ExampleApplication.class).run(args);
    }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>继承式配置</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
继承式配置注解继承自父类
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">启动类继承DewBootApplication类</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public class ExampleApplication extends DewBootApplication类 {

    public static void main(String[] args) throws InterruptedException {
        new SpringApplicationBuilder(ExampleApplication.class).run(args);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>``</code>== 最佳实践</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truejdbc"><a class="anchor" href="#truejdbc"></a>3.5. JDBC框架的选择</h3>
<div class="paragraph">
<p>主流JDBC框架有Hibernate、MyBatis、Spring JDBC Template、Ebean、DBUtils等，Dew基于Spring Boot，所以对于这些框架都提供了很好的兼容。那么如何选择呢？</p>
</div>
<div class="ulist">
<ul>
<li>
<p>先说Hibernate，如果你的数据表结构与对象模型基本吻合，那么使用JPA会带来很大的便捷，推荐Hibernate</p>
</li>
<li>
<p>如果你的数据表结构与对象模型严重不吻合或是你希望对SQL有更多主动权（SQL优化、复杂查询等），那JPA就没什么优势了，这时：</p>
<div class="ulist">
<ul>
<li>
<p>如果你追求极简、不需要ORMPPING，那么DBUtils会是最佳选择</p>
</li>
<li>
<p>如果你喜欢敏捷开发，推崇充血模型，那么尝试一下Ebean吧，与Play!结合最合适不过</p>
</li>
<li>
<p>如果你既要有一定的ORMPPING能力，又希望自己写SQL，那么MyBatis会是不错的选择</p>
</li>
<li>
<p>如果你使用了Spring，希望框架简单些，可以接受自己写ORMPPING，未来无切换关系型数据库的计划，那么Spring JDBC Template将是个很好的选择</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>上述是几个主流JDBC框架的使用场景分析，Dew默认的是哪个呢？Dew默认的是基于Spring JDBC Template的封装，其理由如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Dew做为内部框架，需要能从容地处理公司规划的领域模型结构，但这一数据模型无法与对象模型对应，所以JPA的优势无法体现</p>
</li>
<li>
<p>Dew希望尽可能保持“轻巧”，结构简单、容易上手，Hibernate相对而言过重了</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>基于两个原因Hibernate并不适合使用，又因为：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在数据库设计上一般会存在业务主键、是否启用状态等字段，经常需要针对这些字段查询、修改</p>
</li>
<li>
<p>在数据库设计上一般会存在创建人/时间、更新人/时间等常规字段，在创建、更新对象时需要自动赋值</p>
</li>
<li>
<p>希望能有自动化的ORMPPING功能</p>
</li>
<li>
<p>要求能很好的支持多数据源操作</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>基于这三个原因MyBatis、Ebean、DBUtils及Spring JDBC Template都无法满足要求。</p>
</div>
<div class="paragraph">
<p>所以为适应这一场景需求，Dew基于Spring JDBC Template做了扩展以支持上述功能。</p>
</div>
</div>
<div class="sect2">
<h3 id="true--37"><a class="anchor" href="#true--37"></a>3.6. 服务调用开发期使用</h3>
<div class="paragraph">
<p>在Spring Cloud体系下，服务调用需要启动 <code>Eureka</code> 服务（对于Dew中的 <code>Regstry</code> 组件），这对开发阶段并不友好：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>开发期间会不断启停服务，<code>Eureka</code> 保护机制会影响服务注册（当然这是可以关闭的）</p>
</li>
<li>
<p>多人协作时可能会出现调用到他人服务的情况（同一服务多个实例）</p>
</li>
<li>
<p>需要启动 <code>Eureka</code> 服务，多了一个依赖</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>为解决上述问题,在使用` Spring Cloud` 的 <code>RestTemplate</code> 时,增加 <code>Ribbon</code> 的服务配置.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># &lt;client&gt;为service-id
&lt;client&gt;.ribbon.listOfServers: &lt;直接访问的IPs&gt;
# 如
performance-service.ribbon.listOfServers: 127.0.0.1:8812</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--38"><a class="anchor" href="#true--38"></a>3.7. 断路保护</h3>
<div class="listingblock">
<div class="title">Hystrix配置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties" data-lang="properties"># 执行的隔离策略 THREAD, SEMAPHORE 默认THREAD
hystrix.command.default.execution.isolation.strategy=THREAD
# 执行hystrix command的超时时间,超时后会进入fallback方法 默认1000
hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=1000
# 执行hystrix command是否限制超时,默认是true
hystrix.command.default.execution.timeout.enabled=true
# hystrix command 执行超时后是否中断 默认true
hystrix.command.default.execution.isolation.thread.interruptOnTimeout=true
# 使用信号量隔离时,信号量大小,默认10
hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests=10
# fallback方法最大并发请求数 默认是10
hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests=10
# 服务降级是否开启,默认为true
hystrix.command.default.fallback.enabled=true
# 是否使用断路器来跟踪健康指标和熔断请求
hystrix.command.default.circuitBreaker.enabled=true
# 熔断器的最小请求数,默认20. (这个不是很理解,欢迎补充)
hystrix.command.default.circuitBreaker.requestVolumeThreshold=20
# 断路器打开后的休眠时间,默认5000
hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds=5000
# 断路器打开的容错比,默认50
hystrix.command.default.circuitBreaker.errorThresholdPercentage=50
# 强制打开断路器,拒绝所有请求. 默认false, 优先级高于forceClosed
hystrix.command.default.circuitBreaker.forceOpen=false
# 强制关闭断路器,接收所有请求,默认false,优先级低于forceOpen
hystrix.command.default.circuitBreaker.forceClosed=false

# hystrix command 命令执行核心线程数,最大并发 默认10
hystrix.threadpool.default.coreSize=10</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>信息参见:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Netflix/Hystrix/wiki/Configuration" class="bare">https://github.com/Netflix/Hystrix/wiki/Configuration</a></p>
</li>
<li>
<p><a href="http://hwood.lofter.com/post/1cc7fbdc_e8c5c96" class="bare">http://hwood.lofter.com/post/1cc7fbdc_e8c5c96</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>使用断路保护可有效果的防止系统雪崩，<code>Spring Cloud</code> 对` Hystrix` 做了封装，详见：http://cloud.spring.io/spring-cloud-netflix/single/spring-cloud-netflix.html#_circuit_breaker_hystrix_clients</p>
</div>
<div class="paragraph">
<p>需要说明的是 <code>Hystrix</code> 使用新线程执行代码，导致Threadlocal数据不能同步，使用时需要将用到的数据做为参数传入，如果需要使用Dew框架的上下文（请求链路/用户等获取）需要先传入再设值，e.g.</p>
</div>
<div class="listingblock">
<div class="title">Hystrix Command 示例,及Context处理</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">public class HystrixExampleService {
    @HystrixCommand(fallbackMethod = "defaultFallback", commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", value = "2000")
    })
    public String someMethod(Map&lt;String, Object&gt; parameters, DewContext context) {
        // ！！！ Hystrix使用新线程执行代码，导致Threadlocal数据不能同步，
        // 使用时需要将用到的数据做为参数传入，如果需要使用Dew框架的上下文需要先传入再设值
        DewContext.setContext(context);
        try {
            Thread.sleep(new Random().nextInt(3000));
            logger.info("Normal Service Token:" + Dew.context().getToken());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return "ok";
    }

    // 降级处理方法定义
    public String defaultFallback(Map&lt;String, Object&gt; parameters, DewContext context, Throwable e) {
        DewContext.setContext(context);
        logger.info("Error Service Token:" + Dew.context().getToken());
        return "fail";
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--39"><a class="anchor" href="#true--39"></a>3.8. 配置中心</h3>
<div class="paragraph">
<p>使用 <code>Spring Config</code>  配置中心 <code>refresh</code> 时,在 <code>@RefreshScope</code> 注解的类中,` @Scheduled` 注解的自动任务会失效。
建议使用实现 <code>SchedulingConfigurer</code> 接口的方式添加自动任务。</p>
</div>
<div class="listingblock">
<div class="title">自动任务添加</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Configuration
@EnableScheduling
public class SchedulingConfiguration implements SchedulingConfigurer {

    private Logger logger = LoggerFactory.getLogger(SchedulingConfiguration.class);

    @Autowired
    private ConfigExampleConfig config;

    @Override
    public void configureTasks(ScheduledTaskRegistrar taskRegistrar) {
        taskRegistrar.addTriggerTask(() -&gt; logger.info("task1: " + config.getVersion()), triggerContext -&gt; {
            Instant instant = Instant.now().plus(5, SECONDS);
            return Date.from(instant);
        });

        taskRegistrar.addTriggerTask(() -&gt; logger.info("task2: " + config.getVersion()), new CronTrigger("1/3 * * * * ?"));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-code-ribbon-code"><a class="anchor" href="#true-code-ribbon-code"></a>3.9. <code>ribbon</code> 负载均衡</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
本条实践为<code>netflix</code>的<code>1.3.4.RELEASE</code>版本
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>example: service-dew.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>service-dew</code>为服务名，配置时自行选取规则，类均在<code>com.netflix.loadbalancer</code>包下
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">若指定zone，默认会优先调用相同zone的服务,此优先级高于策略配置，配置如下</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">#指定属于哪个zone
eureka:
  instance:
    metadata-map:
      zone: #zone 名称

#指定region（此处region为项目在不同区域的部署，为项目规范，不同region间能互相调用）
eureka:
  client:
    region: #region名称</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-code-feign-code"><a class="anchor" href="#true-code-feign-code"></a>3.10. <code>feign</code> 配置特定方法超时时间</h3>
<div class="paragraph">
<p><strong><code>hystrix</code> 超时时间配置</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre># 配置默认的hystrix超时时间
hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=10000
# 配置特定方法的超时时间,优于默认配置
hystrix.command.&lt;hystrixcommandkey&gt;.execution.isolation.thread.timeoutInMilliseconds=10000
# &lt;hystrixcommandkey&gt;的format为FeignClassName#methodSignature,下面是示例配置
hystrix.command.PressureService#getBalance(int).execution.isolation.thread.timeoutInMilliseconds=10000</pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>ribbon</code> 超时时间配置</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre># 配置默认ribbon超时时间
ribbon.ReadTimeout=60000
# 配置特定服务超时时间,优于默认配置
&lt;client&gt;.ribbon.ReadTimeout=6000
# &lt;client&gt;为实际服务名,下面是示例配置
pressure-service.ribbon.ReadTimeout=5000</pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>hystrix</code> 和 <code>ribbon</code> 的超时时间配置相互独立,以低为准,使用时请根据实际情况进行配置</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如果要针对某个服务做超时设置,建议使用 <code>ribbon</code> 的配置；在同时使用 <code>ribbon</code> 和 <code>hystrix</code> 时,请特别注意超时时间的配置。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true--40"><a class="anchor" href="#true--40"></a>3.11. 主要性能影响参数</h3>
<div class="paragraph">
<p><strong>内置 <code>tomcat</code> 参数</strong> tomcat参数调整效果并不大,如果需要调整,建议适当调大 <code>max-treads</code> 和 <code>accept-count</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre># 最大等待请求数 默认100
server.tomcat.accept-count=1000
# 最大并发数 默认200
server.tomcat.max-threads=1000
# 最大连接数 默认BIO:200 NIO:10000 APR:8192
server.tomcat.max-connections=2000</pre>
</div>
</div>
<div class="paragraph">
<p><strong><code>zuul</code> 性能参数说明</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre># 连接池最大连接，默认是200
zuul.host.maxTotalConnections=1000
每个route可用的最大连接数，默认值是20
zuul.host.maxPerRouteConnections=1000
Hystrix最大的并发请求 默认值是100
zuul.semaphore.maxSemaphores=1000</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>zuul</code> 的最大并发数主要调整 <code>maxSemaphores</code> 优先级高于 <code>hystrix</code> 的最大线程数配置.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong><code>ribbon</code> 性能参数说明</strong> 调整 <code>MaxTotalConnections</code> 和 <code>MaxConnectionsPerHost</code> 时建议同比调整 <code>Pool</code> 相关的参数</p>
</div>
<div class="literalblock">
<div class="content">
<pre># ribbon 单主机最大连接数,默认50
ribbon.MaxConnectionsPerHost=500
# ribbon 总连接数,默认 200
ribbon.MaxTotalConnections=1000
# 默认200
ribbon.PoolMaxThreads=1000
# 默认1
ribbon.PoolMinThreads=500</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>zuul</code> 和其它使用 <code>ribbon</code> 的服务一样,TPS主要调整 <code>ribbon</code> 的 <code>MaxConnectionsPerHost</code> 和 <code>MaxTotalConnections</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong><code>hystrix</code> 性能参数说明</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre># 并发执行的最大线程数,默认10
hystrix.threadpool.default.coreSize=100</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
普通 <code>service</code> 使用 <code>hystrix</code> 时,最大并发主要调整 <code>hystrix.threadpool.default.coreSize</code>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>hystrix</code> 的默认超时时间为1s,在高并发下容易出现超时,建议将默认超时时间适当调长,
特殊接口需要将时间调短或更长的,使用特定配置,见上面 <code>feign</code> 配置特定方法超时时间.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
详细参见文档 <a href="file://./files/Spring%20Cloud框架负载测试报告.pdf">Spring Cloud框架负载测试报告</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true--41"><a class="anchor" href="#true--41"></a>3.12. 缓存处理</h3>
<div class="paragraph">
<p><code>Spring Cache</code> 提供了很好的注解式缓存，但默认没有超时，需要根据使用的缓存容器特殊配置，e.g.</p>
</div>
<div class="listingblock">
<div class="title">Redis缓存过期时间设置</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">@Bean
RedisCacheManager cacheManager() {
    final RedisCacheManager redisCacheManager = new RedisCacheManager(redisTemplate);
    redisCacheManager.setUsePrefix(true);
    redisCacheManager.setDefaultExpiration(&lt;过期秒数&gt;);
    return redisCacheManager;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--42"><a class="anchor" href="#true--42"></a>3.13. 日志处理</h3>
<div class="paragraph">
<p>对微服务而言 <code>服务API调用</code> 日志可选择 <code>Sleuth</code> + <code>Zipkin</code> 的方案， <code>Dew</code> 没有选择 <code>Zipkin</code> 理由如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Zipkin</code> 需要再部署一套 <code>Zipkin</code> 服务，多了一个依赖</p>
</li>
<li>
<p><code>Zipkin</code> 日志走 <code>HTTP</code> 协议对性能有比较大的影响，走 <code>MQ</code> 方案又会让使用方多了一个技术依赖，且 <code>Rabbit</code> 的性能也是个瓶颈，<code>Kafka</code> 才比较适合</p>
</li>
<li>
<p><code>Zipkin</code> 日志存储方案中 <code>MySQL</code> 有明显的问题， <code>Cassandra</code> 不错，但选型比较偏， <code>ES</code> 最为合适</p>
</li>
<li>
<p><code>Zipkin</code> 方案导致 <code>服务API调用</code> 日志 与 <code>应用程序</code> 日志不统一，后则多选择 <code>ELK</code> 方案</p>
<div class="literalblock">
<div class="content">
<pre>`Dew` 框架采用的是 `Sleuth` + `Slf4j` + `ES`（可选）的方案，因为：</pre>
</div>
</div>
</li>
<li>
<p>简单，使用方没有额外的技术依赖，只要像普通日志一样处理即可</p>
</li>
<li>
<p>统一，所有类型的日志都可统一使用类似 <code>Logback</code> 的日志框架记录，方便统一维护</p>
</li>
<li>
<p>高效，可异步批量提交到 <code>ES</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>当然这一方案会损失一定的可读性，即没有可视化的接口调用展现。</p>
</div>
</div>
<div class="sect2">
<h3 id="trueservo"><a class="anchor" href="#trueservo"></a>3.14. servo 内存泄漏问题</h3>
<div class="paragraph">
<p>已知在某此情况下 <code>servo</code> 统计会导致内存泄漏，如无特殊需要建议关闭 <code>spring.metrics.servo.enabled: false</code></p>
</div>
</div>
<div class="sect2">
<h3 id="true-validated"><a class="anchor" href="#true-validated"></a>3.15. '@Validated'注解</h3>
<div class="ulist">
<ul>
<li>
<p>在Spring controller类里，<code>@Validated</code>注解初使用会比较不易上手，在此做下总结</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对于基本数据类型和String类型，要使校验的注解生效，需在该类上方加<code>@Validated</code>注解</p>
</li>
<li>
<p>对于抽象数据类型，需在形式参数前加<code>@Validated</code>注解</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
spring对抽象数据类型校验抛出异常为<code>MethodArgumentNotValidException</code>，http状态码为400，对基本数据类型校验抛出异常为<code>ConstraintViolationException</code>，http状态码为500，dew对这两种异常做了统一处理，http状态码均返回200，code为400
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truejackson-java8-springmvc-jackson-json"><a class="anchor" href="#truejackson-java8-springmvc-jackson-json"></a>3.16. jackson对于java8时间转换（springmvc以jackson接收json数据）</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对于LocalDateTime类型，需在参数上加<code>@JsonFormat</code>注解，如下：<code>@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")</code></p>
</li>
<li>
<p>LocalDate,LocalTime,Instant等，无需配置可自行转换</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>jackson</code>对于<code>LocalDateTime</code>类型的支持与其他三种类型不具有一致性，这是jackson需要优化的一个点
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueswagger"><a class="anchor" href="#trueswagger"></a>3.17. swagger离线文档</h3>
<div class="ulist">
<ul>
<li>
<p>以启动参数<code>api.file.name</code>指定导出文件名</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">执行如下命令(加上 <code>-Dapi.file.name= [name]</code> 可指定文件名)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell" data-lang="shell">mvn -Dtest=DocTest clean test -P doc

mvn -Dtest=DocTest -Dapi.file.name=dew-example clean test -P doc</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-code-feign-code-http"><a class="anchor" href="#true-code-feign-code-http"></a>3.18. <code>feign</code> 接口添加http请求头信息</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
在FeignClient类中的接口方法里添加新的形参，并加上@RequestHeader注解指定key值
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true-code-zuul-code-http"><a class="anchor" href="#true-code-zuul-code-http"></a>3.19. <code>zuul</code> 保护(隐藏)内部服务的http接口</h3>
<div class="paragraph">
<p>在yml配置文件里配置(<code>ignored-patterns</code>,<code>ignored-services</code>)这两项中的一项即可</p>
</div>
<div class="listingblock">
<div class="title">配置示例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">zuul: #配置一项即可!
  ignored-patterns: /dew-example/**   #排除此路径
  ignored-services: dew-example       #排除此服务</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truespring-boot-admin"><a class="anchor" href="#truespring-boot-admin"></a>3.20. Spring Boot Admin 监控实践</h3>
<div class="paragraph">
<p>在<code>Spring Boot Actuator</code>中提供很多像<code>health</code>、<code>metrics</code>等实时监控接口，可以方便我们随时跟踪服务的性能指标。
<code>Spring Boot</code>默认是开放这些接口提供调用的，那么就问题来了，如果这些接口公开在外网中，很容易被不法分子所利用，这肯定不是我们想要的结果。
在这里我们提供一种比较好的解决方案</p>
</div>
<div class="ulist">
<ul>
<li>
<p>被监控的服务配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">为被保护的http请求添加请求前缀</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">management:
  context-path: /dew-example <i class="conum" data-value="1"></i><b>(1)</b>
eureka:
  instance:
    status-page-url-path: ${management.context-path}/info <i class="conum" data-value="2"></i><b>(2)</b>
    health-check-url-path: ${management.context-path}/health</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>添加请求前缀</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Spring Boot Admin</code>在启动的时候会去<code>eureka</code>拉去服务信息，其中<code>health</code>与<code>info</code>需要特殊处理，这两者的地址是根据<code>status-page-url-path</code>和<code>health-check-url-path</code>的值</td>
</tr>
</table>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>zuul</code>网关配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><code>zuul</code>保护内部服务http接口</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">zuul:
  ignoredPatterns: /*/dew-example/** <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>这里之所以不是<code>/dew-example/**</code>，由于网关存在项目前缀，需要往前一级，大家可以具体场景具体配置</td>
</tr>
</table>
</div>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Spring Boot Admin</code>配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">配置监控的指标参数</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">spring:
  application:
    name: monitor
  boot:
    admin:
      discovery:
        converter:
          management-context-path: /dew-example # The endpoints URL prefix <i class="conum" data-value="1"></i><b>(1)</b>
      routes:
        endpoints: env,metrics,dump,jolokia,info,configprops,trace,logfile,refresh,flyway,liquibase,heapdump,loggers,auditevents,hystrix.stream
      turbine:
        clusters: default
        location: monitor

turbine:
  aggregator:
    clusterConfig: default
  appConfig: monitor-example <i class="conum" data-value="2"></i><b>(2)</b>
  clusterNameExpression: metadata['cluster']</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>与应用配置的management.context-path相同</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>添加需要被监控的应用Service-Id，以逗号分隔</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--43"><a class="anchor" href="#true--43"></a>4. 技术指标</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true--44"><a class="anchor" href="#true--44"></a>4.1. 性能</h3>
<div class="paragraph">
<p>服务器基本情况介绍
    172.30.250.153
        cpu:4核
        内存:4G内存
        网络：内网</p>
</div>
<div class="literalblock">
<div class="content">
<pre>172.30.249.186
    cpu:4核
    内存:4G内存
    网络:内网
    ps:有其它程序在跑暂用一定的内存空间可用内存2G左右</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>172.30.249.183
    cpu:4核
    内存:4G
    网络:内网
    ps:有其它程序在跑暂用一定的内存空间可用内存2G左右</pre>
</div>
</div>
<div class="paragraph">
<p>所有程序介绍:
    注册中心:registry[Eureka Server]
    网关:gateway[Zuul]
    对外服务接口:pressure-test-api
    具体服务实现:pressure-test-service</p>
</div>
<div class="paragraph">
<p>程序部署情况：
    在172.30.250.153部署
        Eureka Server 部署路径--&#8594;&gt;&gt;/home/release/apps/registry
        Zuul 部署路径--&#8594;&gt;&gt;/home/release/apps/gateway</p>
</div>
<div class="literalblock">
<div class="content">
<pre>在172.30.249.186部署
    pressure-test-api 部署路径---&gt;&gt;&gt;/opt/spring-cloud-client</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>在172.30.249.183部署
    pressure-test-service 部署路径---&gt;&gt;&gt;/opt/spring-cloud-service</pre>
</div>
</div>
<div class="paragraph">
<p>程序中影响性能的参数</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1.四个程序tomcat的配置如下[全部相同]：
    server.tomcat.accept-count=1000
    server.tomcat.max-threads=1000
    server.tomcat.max-connections=2000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>2.Eureka Server其它参数：
    eureka.server.enable-self-preservation=false
    eureka.server.remote-region-fetch-thread-pool-size=500
    eureka.server.remote-region-read-timeout-ms=5000
    eureka.server.remote-region-total-connections=1000
    eureka.server.remote-region-total-connections-per-host=500</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>3.gateway其它参数：
    eureka.host.max-per-route-connections=2000
    eureka.host.max-total-connections=2000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>zuul.host.maxTotalConnections=1000
zuul.host.maxPerRouteConnections=1000
zuul.semaphore.maxConcurrentRequests=1000
zuul.semaphore.maxSemaphores=1000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>ribbon.MaxConnectionsPerHost=500
ribbon.MaxTotalConnections=1000
ribbon.PoolMaxThreads=1000
ribbon.PoolMinThreads=500
ribbon.ReadTimeout=6000
ribbon.ConnectTimeout=6000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>hystrix.command.isolation.thread.timeoutInMilliseconds=10000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>4.pressure-test-api其它参数:
    eureka.host.max-per-route-connections=2000
    eureka.host.max-total-connections=2000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>ribbon.ServerListRefreshInterval=1000
ribbon.MaxConnectionsPerHost=500
ribbon.MaxTotalConnections=1000
ribbon.PoolMaxThreads=1000
ribbon.PoolMinThreads=500
ribbon.ReadTimeout=6000
ribbon.ConnectTimeout=6000</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>5.pressure-test-service其它参数：
    eureka.host.max-per-route-connections=2000
    eureka.host.max-total-connections=2000</pre>
</div>
</div>
<div class="paragraph">
<p>服务之间调用情况:
    gateway,pressure-test-api,pressure-test-service三者服务全部注册在registry中。
    测试发起，首先掉用gateway服务，蒋分发到pressure-test-api中，pressure-test-api调用pressure-test-service，最后将结果返回。
    ps:pressure-test-api 通过ribbon[负载均衡]来调用pressure-test-service</p>
</div>
<div class="paragraph">
<p>测试结果：</p>
</div>
<div class="literalblock">
<div class="content">
<pre>测试条件:
    1.并发线程数:350
    2.持续运行10分钟
    3.模拟执行服务时间为200毫秒
测试结果:
    总请求数:781372
    成功:100%
    Thoughput:1300/s
    Average:268
    Median:203
    90%line:211
    95%line:222
    99%line:3835
    Min:201
    Max:7272</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>测试条件:
    1.并发线程数:250
    2.持续运行11分钟
    3.模拟执行服务时间为200毫秒
测试结果:
    总请求数:811963
    成功:100%
    Thoughput:1225/s
    Average:203
    Median:203
    90%line:205
    95%line:210
    99%line:222
    Min:201
    Max:545</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>测试条件:
    1.并发线程数:500
    2.持续运行10分钟
    3.模拟执行服务时间为200毫秒
测试结果:
    总请求数:751614
    成功:100%
    Thoughput:1247/s
    Average:400
    Median:204
    90%line:231
    95%line:284
    99%line:7209
    Min:201
    Max:7569</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>在业务处理时间为200毫秒，tomcat设置为1000线程的情况下，并发量为250比较合理。99%line也只有222毫秒。超过250的并发量，建议修改参数。</pre>
</div>
</div>
<div class="paragraph">
<p>参数修改建议:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>参数具体参看：
eureka-server:
org.springframework.cloud:spring-cloud-netflix-eureka-server:1.3.1.RELEASE.jar/META-INF/spring-configuration-metadata.json
eureka-client:
org.springframework.cloud:spring-cloud-netflix-eureka-client:1.3.1.RELEASE.jar/META-INF/spring-configuration-metadata.json
feign、ribbon、zuul:
org.springframework.cloud:spring-cloud-netflix-core:1.3.1.RELEASE.jar/META-INF/spring-configuration-metadata.json
Hystrix:
https://github.com/Netflix/Hystrix/wiki/Configuration
ribbon:
参数名参考:https://github.com/Netflix/ribbon/blob/master/ribbon-core/src/main/java/com/netflix/client/config/CommonClientConfigKey.java#L83
参数默认值:https://github.com/Netflix/ribbon/blob/3a707ec518a896053be44266dddc4c4f925f4e60/ribbon-core/src/main/java/com/netflix/client/config/DefaultClientConfigImpl.java#L331</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>如果默认配置不能满足性能要求，首先调高所有服务的tomcat的线程配置。accept-count[可以等待请求数量],max-threads[最大并发数量],max-connections[最大链接数]
调整了tomcat以后，使用到了ribbon服务的地方需要调整ribbon的连接数大小。然后调整zuul[网关]连接数池大小。</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>当gateway[网关]中的ribbon的连接数没有调整的情况，测试结果中的Thoughput只能保持在200多，访问时长max异常的大。
分析原因:gateway[网关]接收到请求以后，通过ribbon[负载均衡服务]去调用具体的服务。虽然gateway的tomcat能接受非常的多请求，但是ribbon线程数默认较小,很多请求在等待。
这样导致max会异常的大。因为ribbon线程数默认较小，调用服务的线程数也较少，反应出来的情况就是服务的Thoughput并不是特别的高。Ps:实际上只需要调整MaxConnectionsPerHost,
MaxTotalConnections两个参数，改问题就能解决，这里还是建议将Pool的参数也同等比例的调整放大比较合适。</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--45"><a class="anchor" href="#true--45"></a>5. 开发指南</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truescm"><a class="anchor" href="#truescm"></a>5.1. SCM</h3>
<div class="paragraph">
<p><a href="https://rep.360taihe.com/csp/dew-framework/">https://rep.360taihe.com/csp/dew-framework/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="true--46"><a class="anchor" href="#true--46"></a>5.2. 环境要求</h3>
<div class="paragraph">
<p>基础环境： <code>&gt;=java8</code></p>
</div>
<div class="paragraph">
<p>调试环境： 推荐使用Docker环境准备各个容器</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell" data-lang="shell"># MySQL环境
docker run -d --name dew-mysql -p 3306:3306 -e MYSQL_DATABASE=dew -e MYSQL_ROOT_PASSWORD=123456 mysql
# Redis环境
docker run -d --name dew-redis -p 6379:6379 redis
# Rabbit环境
docker run -d --name dew-rabbit --hostname dew-rabbit -p 15671:15671 -p 15672:15672 -p 4369:4369 -p 5671:5671 -p 5672:5672 -p 25672:25672 -e RABBITMQ_DEFAULT_USER=root -e RABBITMQ_DEFAULT_PASS=123456 -e RABBITMQ_DEFAULT_VHOST=dew rabbitmq:3-management-alpine
# Hazelcast环境
docker run -d --name dew-hazelcast -p 5701:5701 hazelcast/hazelcast
# Ignite环境
docker run -d --name dew-ignite -p 11211:11211 -p 47100:47100 -p 47500:47500 -p 49112:49112 apacheignite/ignite
# Zookeeper环境
docker run -d --name dew-zookeeper -p 2181 -t wurstmeister/zookeeper
# Kafka环境
docker run --name dew-kafka -e HOST_IP=localhost -e KAFKA_ADVERTISED_PORT=9092 -e KAFKA_BROKER_ID=1 -e ZK=zk -p 9092:9092 --link dew-zookeeper:zk -t wurstmeister/kafka
# ELK环境
docker run -d --name dew-elk -p 5601:5601 -p 9200:9200 -p 5044:5044 -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" sebp/elk</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--47"><a class="anchor" href="#true--47"></a>6. 编译部署</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true--48"><a class="anchor" href="#true--48"></a>6.1. 开发期热部署</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
使用 <code>Dubbo</code> 的工程不能与此插件兼容！
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
    &lt;optional&gt;true&lt;/optional&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>设置IDE(以Intellij IDEA为例)</p>
<div class="ulist">
<ul>
<li>
<p><code>Setting</code> &#8594; <code>Build,Executiion,Deployment&gt;Compiler</code>，勾选 <code>Build project automatically</code></p>
</li>
<li>
<p><code>Shift+Ctrl+Alt+/</code> &#8594; 选择 <code>Registry</code>，出现 <code>Maintenance</code> 窗口，勾选 <code>compiler.automake.allow.when.app.running</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="true--49"><a class="anchor" href="#true--49"></a>6.2. 打包</h3>
<div class="paragraph">
<p><code>mvn clean package -P fatjar</code> 即可打出一个包含所有依赖的包，后把 <code>target</code> 目录下生成的jar放到 <code>release/apps</code> 下。</p>
</div>
</div>
<div class="sect2">
<h3 id="true--50"><a class="anchor" href="#true--50"></a>6.3. 部署</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">release目录说明</div>
<div class="paragraph">
<p>release是发布用的目录，对应的目录 <code>apps</code> 是应用级目录，所有的应用都放在这个目录下， <code>apps</code> 是可用服务的目录， <code>dew</code> 这是部署用的shell脚本。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="true--51"><a class="anchor" href="#true--51"></a>6.3.1. 准备</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在服务器上创建根目录，如 <code>/opt/dew/</code></p>
</li>
<li>
<p>将服务器上 <code>dew</code> 文件赋予可执行权限</p>
</li>
<li>
<p>修改本地 <code>release/apps</code> 中各组件的配置信息，主要关注日志的路径、第三方服务的连接信息、应用的端口等</p>
</li>
<li>
<p>清空数据库、redis，Redis使用 <code>flushall命令</code></p>
</li>
<li>
<p>执行 <code>./dew start_dew</code> 启动dew的各服务</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="true--52"><a class="anchor" href="#true--52"></a>6.3.2. 手工发布</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>手工打包各组件放到 <code>release/apps</code> 目录下</p>
</li>
<li>
<p>将项目 <code>release</code> 上传到服务器 <code>/opt/dew/services</code> 目录</p>
</li>
<li>
<p>执行 <code>./dew deploy &lt;组件名&gt;</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="trueci"><a class="anchor" href="#trueci"></a>6.3.3. CI</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在CI中将打包的jar放置在 <code>prepare</code> 目录中</p>
</li>
<li>
<p>在CI中运程执行 <code>./dew deploy &lt;组件名&gt;</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--53"><a class="anchor" href="#true--53"></a>7. 配置速查</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true-code-dew-code"><a class="anchor" href="#true-code-dew-code"></a>7.1. <code>Dew</code> 参数</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">dew: # Dew 参数key前缀
    basic: # 基础信息
        name: # 服务名称，用于API文档显示等
        version: 1.0 # 服务版本号，用于API文档显示等
        desc: # 服务描述，用于API文档显示等
        webSite: # 官网，用于API文档显示等
        doc:
            enabled: true # 是否启用默认文档配置，关闭后可自定义文档管理
            base-package: # API文档要扫描的根包，多指定到 Controller 包中
        format:
        use-unity-error: true # 是否启用统一响应
        reuse-http-state: false # true:重用http状态码，false:使用协议无关格式
        error-mapping: # 自定义错误映射
            "[&lt;异常类名&gt;]":
                http-code: # http状态码，不存在时使用实例级http状态码
                business-code: # 业务编码，不存在时使用实例级业务编码
                message: # 错误描述，不存在时使用实例级错误描述
    cluster: # 集群功能
        cache: redis # 缓存实现
        dist: redis # 分布式锁和Map实现，可选 redis/hazelcast
        mq: redis # MQ实现，可选 redis/hazelcast/rabbit
        election: eureka # 领导者选举实现，可选 eureka
    jdbc: # DewJDBC 功能
        base-packages:[""] # 要扫描的根包，多指定到 jdbc 包中
    security: # 安全功能
        cors:
            allow-origin: * # 允许的来源，建议修改
            allow-methods: POST,GET,OPTIONS,PUT,DELETE,HEAD # 允许的方法
            allow-headers: x-requested-with,content-type # 允许的头信息
        token-flag: __dew_token__ # token 标识
        token-in-header: true # true：token标识在 header 中，反之在url参数中
        token-hash: false # token值是否需要hash，用于解决token值有特殊字符的情况
        include-services: [""] # 服务白名单，要求源服务头部带上 Request-From
        exclude-services: [""] # 服务黑名单，要求源服务头部带上 Request-From
        auth: # 特殊的认证功能，基础认证不需要配置
            csp:  # csp模式，引用csp-starter后默认使用该模式
                party-id: X-User-Id #partyId在header中的key值
                app-id: X-App-Id #appId在header中的key值
                roles: X-Roles #角色在header中的key值，逗号分隔
    cloud:
        trace-log:
            enabled: true # 是否启用服务API调用（追踪）日志
        error:
             notify-interval-sec: 1800 # 通知的间隔时间
             notify-emails:  # 通知的邮箱，逗号分隔
             notify-event-types: FAILURE,SHORT_CIRCUITED,TIMEOUT,THREAD_POOL_REJECTED,SEMAPHORE_REJECTED # 通知的事件类型
             notify-include-keys: # 需监控的方法key值，与notify-exclude-keys互斥，client类名+#+方法名，for example:  ExampleClient#deleteExe(int,String)
             notify-exclude-keys: # 不需要监控的方法key值，与notify-include-keys互斥，client类名+#+方法名，for example:  ExampleClient#deleteExe(int,String)
    idempotent:
        default-expire-ms: 3600000 # 设置默认过期时间，1小时
        default-strategy: item # 设置默认策略，支持 bloom(Bloom Filter)和item(逐条记录)
        opt-type-flag: __IDEMPOTENT_OPT_TYPE__ # 指定幂等操作类型标识，可以位于HTTP Header或请求参数中
        opt-id-flag: __IDEMPOTENT_OPT_ID__ # 指定幂等操作ID标识，可以位于HTTP Header或请求参数中
    metric:
        enabled: true # 是否启用Dew的指标统计
        period-sec: 默认600 # 指定统计周期（多少秒内的指标统计）
spring:
  datasource: # 主数据源配置
        ... # 数据源配置，详见 Spring boot 核心参数
       druid: # druid 连接池配置，详见 Spring boot 核心参数
  multi-datasources: # DewJDBC 多数据源支撑
       &lt;other ds name&gt;: # 数据源标识
  mail: #mail配置，需要hystrix降级通知需加以下配置
       host: smtp.163.com
       username:
       password:
       properties:
         mail:
           smtp:
             auth: true
             starttls:
               enable: true
               required: true

#sharding-jdbc配置（分库分表样例，详细见使用手册及sharding-example）
sharding:
  jdbc:
    datasource:
      names: ds_0,ds_1
      ds_0:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/ds_yaml_0
        username: root
        password: 123456
      ds_1:
        type: org.apache.commons.dbcp.BasicDataSource
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://localhost:3306/ds_yaml_1
        username: root
        password: 123456
    config:
      sharding:
        tables:
          t_order:
            actualDataNodes: ds_${0..1}.t_order_${0..1}
            #generateKeyColumns:
              #- columnName: order_id
            tableStrategy:
              inline:
                shardingColumn: order_id
                algorithmInlineExpression: t_order_${order_id.longValue() % 2}
          t_order_item:
            actualDataNodes: ds_${0..1}.t_order_item_${0..1}
            tableStrategy:
              inline:
                shardingColumn: order_id
                algorithmInlineExpression: t_order_item_${order_id.longValue() % 2}
        #绑定表中其余的表的策略与第一张表的策略相同
        bindingTables:
          - t_order,t_order_item
        #默认数据库分片策略
        defaultDatabaseStrategy:
          inline:
            shardingColumn: user_id
            algorithmInlineExpression: ds_${user_id.longValue() % 2}
        props:
          sql.show: false</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-code-spring-boot-code"><a class="anchor" href="#true-code-spring-boot-code"></a>7.2. <code>Spring boot</code> 核心参数</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html" class="bare">https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true-code-druid-code"><a class="anchor" href="#true-code-druid-code"></a>7.3. <code>Druid</code> 连接池参数</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/alibaba/druid/wiki/DruidDataSource配置属性列表" class="bare">https://github.com/alibaba/druid/wiki/DruidDataSource配置属性列表</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="true-code-spring-cloud-code"><a class="anchor" href="#true-code-spring-cloud-code"></a>7.4. <code>Spring cloud</code> 核心参数</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="http://cloud.spring.io/spring-cloud-static/spring-cloud-netflix/1.3.4.RELEASE/" class="bare">http://cloud.spring.io/spring-cloud-static/spring-cloud-netflix/1.3.4.RELEASE/</a>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--54"><a class="anchor" href="#true--54"></a>8. 版本说明</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true1-2-0-rc"><a class="anchor" href="#true1-2-0-rc"></a>8.1. 1.2.2-RC</h3>
<div class="sect3">
<h4 id="truefeature"><a class="anchor" href="#truefeature"></a>8.1.1. Feature</h4>
<div class="ulist">
<ul>
<li>
<p>#75 添加幂等处理功能， #77 可选策略类型Bloom Filter尚在开发中</p>
</li>
<li>
<p>#72 实现针对服务整体及每个接口的TPS、最大/平均/90%响应时间Metrics统计</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement"><a class="anchor" href="#trueimprovement"></a>8.1.2. Improvement</h4>
<div class="ulist">
<ul>
<li>
<p>#68 支持自定义离线文档文件名</p>
</li>
<li>
<p>#70 更友好地获取本机Host</p>
</li>
<li>
<p>#76 cluster.cache 支持更多类型的操作</p>
</li>
<li>
<p>#53 统一响应——协议无关 降级由 <code>1000</code> 改成 <code>555</code> 以提升兼容性</p>
</li>
<li>
<p>#79 增加是否启用默认文档配置</p>
</li>
<li>
<p>#80 增加注解启用Dew功能</p>
</li>
<li>
<p>Swagger文档去除全局token参数</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truefixed"><a class="anchor" href="#truefixed"></a>8.1.3. Fixed</h4>
<div class="ulist">
<ul>
<li>
<p>#43 swagger2markup-maven-plugin 在使用 spring.content-path 无效</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="true-code-1-1-0-rc-code-code-1-2-0-rc-code"><a class="anchor" href="#true-code-1-1-0-rc-code-code-1-2-0-rc-code"></a>8.1.4. 从 <code>1.1.0-RC</code> 迁移到 <code>1.2.2-RC</code></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>使用 <code>统一响应——协议无关</code> 类型时，UI端由原来只需要获取200状态下的数据改成需要获取 200 和 555 状态下的数据，两者对UI端没有区别。( @See <a href="https://rep.360taihe.com/csp/dew-framework/issues/53" class="bare">https://rep.360taihe.com/csp/dew-framework/issues/53</a> )</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true1-1-0-rc"><a class="anchor" href="#true1-1-0-rc"></a>8.2. 1.1.0-RC</h3>
<div class="sect3">
<h4 id="truefeature-2"><a class="anchor" href="#truefeature-2"></a>8.2.1. Feature</h4>
<div class="ulist">
<ul>
<li>
<p>[功能] #45 支持服务调用（ <code>Hystrix</code> ）异常邮件通知</p>
</li>
<li>
<p>[功能] #51 适配新版 <code>用户权限中心</code> SDK</p>
</li>
<li>
<p>[功能] #59 #49 #15 统一日志规范，适配 <code>sleuth</code> 日志到 <code>ES</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-2"><a class="anchor" href="#trueimprovement-2"></a>8.2.2. Improvement</h4>
<div class="ulist">
<ul>
<li>
<p>[优化] #53 统一响应——协议无关 类型的http返回码由统一的200改成 <code>200</code> 或 <code>1000</code> ，前者表示操作成功或不需要降级的错误，后者表示需要做降级（Hystrix fallback）的错误</p>
</li>
<li>
<p>[优化] #50 <code>Dew JDBC</code> 更好地支持没有 <code>Entity</code> 注解的对象</p>
</li>
<li>
<p>[优化] #52 对于java8时间，url参数转换支持String转LocalDateTime,LocalDate、LocalTime,long转LocalDateTime(但json数据不支持)，long转Instant</p>
</li>
<li>
<p>[优化] #55 #58 其它一些优化</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-2"><a class="anchor" href="#truefixed-2"></a>8.2.3. Fixed</h4>

</div>
<div class="sect3">
<h4 id="true-code-1-1-0-beta1-code-code-1-1-0-rc-code"><a class="anchor" href="#true-code-1-1-0-beta1-code-code-1-1-0-rc-code"></a>8.2.4. 从 <code>1.1.0-beta1</code> 迁移到 <code>1.1.0-RC</code></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>使用 <code>统一响应——协议无关</code> 类型时，UI端由原来只需要获取200状态下的数据改成需要获取 200 和 1000 状态下的数据，两者对UI端没有区别。( @See <a href="https://rep.360taihe.com/csp/dew-framework/issues/53" class="bare">https://rep.360taihe.com/csp/dew-framework/issues/53</a> )</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true1-1-0-beta1"><a class="anchor" href="#true1-1-0-beta1"></a>8.3. 1.1.0-beta1</h3>
<div class="sect3">
<h4 id="truefeature-3"><a class="anchor" href="#truefeature-3"></a>8.3.1. Feature</h4>
<div class="ulist">
<ul>
<li>
<p>[功能] #19 支持局部 <code>ShardingJDBC</code>(由于ShardingJDBC 2.0还未RC，测试发现存在较多问题，此功能需要等待官方RC)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-3"><a class="anchor" href="#trueimprovement-3"></a>8.3.2. Improvement</h4>
<div class="ulist">
<ul>
<li>
<p>[优化] 支持Java8时间处理</p>
</li>
<li>
<p>[优化] #34 模块Spring化，<code>boot-core</code> 更名为 <code>boot-starter</code> , <code>cloud-core</code> 更名为 <code>cloud-starter</code></p>
</li>
<li>
<p>[优化] #40 <code>Dew JDBC</code> 独立成 <code>jdbc-starter</code> , 确保核心模块 <code>boot-starter</code> 更轻量</p>
</li>
<li>
<p>[优化] <code>Dew JDBC</code> 性能优化</p>
</li>
<li>
<p>[文档] #47 添加性能调优章节</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-3"><a class="anchor" href="#truefixed-3"></a>8.3.3. Fixed</h4>
<div class="ulist">
<ul>
<li>
<p>[修正] 统一错误拦截返回指定为 <code>MediaType=APPLICATION_JSON_UTF8</code> 以解决 <code>Feign</code> 调用解码错误</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="true-code-1-0-0-rc-betax-code-code-1-1-0-code"><a class="anchor" href="#true-code-1-0-0-rc-betax-code-code-1-1-0-code"></a>8.3.4. 从 <code>1.0.0-RC/betaX</code> 迁移到 <code>1.1.0</code></h4>
<div class="paragraph">
<p><code>1.1.0</code> 修正了 <code>1.0.0</code> 版本的几个设计缺陷，需要做如下的迁移操作：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven: <code>Dew</code> 框架的版本修正成 <code>1.1.0-X</code>，目前是 <code>1.1.0-beta1</code></p>
</li>
<li>
<p>Maven: <code>boot-core</code> 更名为 <code>boot-starter</code> , <code>cloud-core</code> 更名为 <code>cloud-starter</code></p>
</li>
<li>
<p>核心代码: <code>com.ecfront.dew.core.Dew</code> 包路径改成 <code>com.ecfront.dew.Dew</code></p>
</li>
<li>
<p><code>Dew JDBC</code> 模块（使用MyBatis等其它持久化框架的项目可以忽略）</p>
<div class="ulist">
<ul>
<li>
<p><code>SafeEntity</code> 的创建/更新时间 由 <code>Date</code> 换成了 <code>LocalDateTime</code></p>
</li>
<li>
<p>所有 <code>entity</code> 包 迁移到 <code>com.ecfront.dew.jdbc.entity</code></p>
</li>
<li>
<p>使用 <code>JdbcTemplate</code> 原生方法时 原来是： <code>Dew.ds().jdbc.xx</code> ，需要修改成 <code>((DewDS)Dew.ds).jdbc.xx</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true1-0-0-rc"><a class="anchor" href="#true1-0-0-rc"></a>8.4. 1.0.0-RC</h3>
<div class="sect3">
<h4 id="truefeature-4"><a class="anchor" href="#truefeature-4"></a>8.4.1. Feature</h4>
<div class="ulist">
<ul>
<li>
<p>[功能]支持新版用户权限中心认证适配(* 新版用户权限中心Release后，此功能代码会有一定变更)</p>
</li>
<li>
<p>[功能]新增SqlBuilder用于快速构建SQL语句</p>
</li>
<li>
<p>[移除]由于 Spring Cloud Thrift RPC 测试不够充分，此版本中暂时移除</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-4"><a class="anchor" href="#trueimprovement-4"></a>8.4.2. Improvement</h4>
<div class="ulist">
<ul>
<li>
<p>[功能]支持rabbit confirm(单条)模式</p>
<div class="literalblock">
<div class="content">
<pre>((RabbitClusterMQ)Dew.cluster.mq).publish(String topic, String message, boolean confirm)
((RabbitClusterMQ)Dew.cluster.mq).request(String address, String message, boolean confirm)</pre>
</div>
</div>
</li>
<li>
<p>[功能]支持 <code>EnabledColumn</code> 结果反转，EnabledColumn用于标识是否启用状态的注解，默认是true是否用，false是禁用，但有些情况下状态字段会使用<code>del_flag</code>表示是否删除，这时需要设置结果反转</p>
</li>
<li>
<p>[功能]统一Body及Url Path/Query的异常捕获</p>
</li>
<li>
<p>[功能] <code>tryLock</code> 支持重入</p>
</li>
<li>
<p>[测试]引入 <code>embedded redis</code> 以支持单元测试</p>
</li>
<li>
<p>[文档]添加 以宠物商店为例的 <code>新手入门</code> 章节</p>
</li>
<li>
<p>[修改]原 <code>dew.dao.base-package</code> 改成 <code>dew.jdbc.base-packages</code> 支持多个路径</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-4"><a class="anchor" href="#truefixed-4"></a>8.4.3. Fixed</h4>
<div class="ulist">
<ul>
<li>
<p>修正Redis锁 <code>Unlock</code> 处理的线程问题</p>
</li>
<li>
<p>修正jacoco单元测试覆盖率偏少的问题</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true1-0-0-beta5"><a class="anchor" href="#true1-0-0-beta5"></a>8.5. 1.0.0-beta5</h3>
<div class="sect3">
<h4 id="truefeature-5"><a class="anchor" href="#truefeature-5"></a>8.5.1. Feature</h4>
<div class="ulist">
<ul>
<li>
<p>添加服务调用限制（可定义A服务不允许B服务调用，防止服务双向依赖） e.g.</p>
<div class="literalblock">
<div class="content">
<pre>dew.security.exclude-services:
 - serviceB
 - serviceC</pre>
</div>
</div>
</li>
<li>
<p>添加对Thrift的支持</p>
</li>
<li>
<p>支持集群Leader Election（非严格模式）</p>
</li>
<li>
<p>整合Spring Boot Cache</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-5"><a class="anchor" href="#trueimprovement-5"></a>8.5.2. Improvement</h4>
<div class="ulist">
<ul>
<li>
<p>优化CURD脚手架</p>
</li>
<li>
<p>支持UUID形式的主键</p>
</li>
<li>
<p>优化注解自定义查询（ <code>@Select</code> ），通过测试</p>
</li>
<li>
<p>支持自定义异常配置，见 <code>异常处理</code> 章节</p>
</li>
<li>
<p>添加Bean分组校验说明，见 <code>异常处理</code> 章节</p>
</li>
<li>
<p>添加 <code>Sonar</code> 代码质量检查，配置 <code>sonar.host.url</code> 执行 <code>mvn clean verify sonar:sonar</code></p>
</li>
<li>
<p>【需要迁移】使用Druid数据库连接池（注意数据库连接配置变更）</p>
</li>
<li>
<p>【需要迁移】删除 <code>DaoImpl</code> 兼容性类</p>
</li>
<li>
<p>【需要迁移】将 <code>Dew.e</code> 移到 <code>Dew.E.e</code>，添加 <code>Dew.E.checkXX</code>异常检查方法，见 <code>异常处理</code> 章节</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-5"><a class="anchor" href="#truefixed-5"></a>8.5.3. Fixed</h4>
<div class="ulist">
<ul>
<li>
<p>修正事务失败，重试成功后还是被回滚的问题</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true1-0-0-beta4"><a class="anchor" href="#true1-0-0-beta4"></a>8.6. 1.0.0-beta4</h3>
<div class="sect3">
<h4 id="truefeature-6"><a class="anchor" href="#truefeature-6"></a>8.6.1. Feature</h4>
<div class="ulist">
<ul>
<li>
<p>整合 <code>Spring boot admin</code> 与 <code>Turbine</code>，可直观的监控各个性能及访问指标</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/spring-boot-admin.png" alt="spring boot admin.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>添加实验功能：使用注解自定义查询（ <code>@Select</code> ）</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-6"><a class="anchor" href="#trueimprovement-6"></a>8.6.2. Improvement</h4>
<div class="ulist">
<ul>
<li>
<p>添加了几个自定义验证方式</p>
</li>
<li>
<p>添加性能测试报告</p>
</li>
<li>
<p>移除 <code>DaoImpl</code> ，改用接口 <code>DewDao</code></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
为确保兼容， <code>DaoImpl</code> 在这一版本中未物理移除，如有条件请迁移至 <code>DewDao</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-6"><a class="anchor" href="#truefixed-6"></a>8.6.3. Fixed</h4>

</div>
</div>
<div class="sect2">
<h3 id="true1-0-0-beta3"><a class="anchor" href="#true1-0-0-beta3"></a>8.7. 1.0.0-beta3</h3>
<div class="sect3">
<h4 id="truefeature-7"><a class="anchor" href="#truefeature-7"></a>8.7.1. Feature</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cluster的MQ添加RabbitMQ SPI</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-7"><a class="anchor" href="#trueimprovement-7"></a>8.7.2. Improvement</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>支持自定义http错误码( <code>Dew.e(String code, E ex, StandardCode customHttpCode)</code> )</p>
</li>
<li>
<p>对加了字段校验(@Valid)的对象，如果检验失败会返回错误详细</p>
</li>
<li>
<p>开放将ResultSet转成对象的方法( <code>ds.convertRsToObj(Map&lt;String, Object&gt; rs, Class&lt;E&gt; entityClazz)</code> )</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-7"><a class="anchor" href="#truefixed-7"></a>8.7.3. Fixed</h4>

</div>
</div>
<div class="sect2">
<h3 id="true1-0-0-beta2"><a class="anchor" href="#true1-0-0-beta2"></a>8.8. 1.0.0-Beta2</h3>
<div class="sect3">
<h4 id="truefeature-8"><a class="anchor" href="#truefeature-8"></a>8.8.1. Feature</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>支持生成Html及PDF版本的离线文档</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-8"><a class="anchor" href="#trueimprovement-8"></a>8.8.2. Improvement</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>添加Dubbo整合示例，提供Dubbo服务提供无法处理<code>声明式事务</code>的方案</p>
</li>
<li>
<p>完善文档并改用asciidoc格式</p>
</li>
<li>
<p>统一依赖管理</p>
</li>
<li>
<p><code>parent</code> 中添加公司maven库</p>
</li>
<li>
<p>Hazelcast Client升级到3.8.2</p>
</li>
<li>
<p>Dew-Common升级到1.3.7</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-8"><a class="anchor" href="#truefixed-8"></a>8.8.3. Fixed</h4>

</div>
</div>
<div class="sect2">
<h3 id="true1-0-0-beta1"><a class="anchor" href="#true1-0-0-beta1"></a>8.9. 1.0.0-beta1</h3>
<div class="sect3">
<h4 id="truefeature-9"><a class="anchor" href="#truefeature-9"></a>8.9.1. Feature</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>多数据源支持，详见说明文档<code>多数据源支持</code>章节</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
原<code>Dew.ds.xx</code>接口弃用，改为<code>Dew.ds().xx</code>，如需要使用其它数据源请使用<code>Dew.ds(&lt;DS Name&gt;).xx</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueimprovement-9"><a class="anchor" href="#trueimprovement-9"></a>8.9.2. Improvement</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>新增<code>mybatisplus-example</code></p>
</li>
<li>
<p>改善<code>Swagger</code>文档支持</p>
</li>
<li>
<p>新增销毁时间支持：<code>boolean tryLock(long waitMillSec, long leaseMillSec)</code></p>
</li>
<li>
<p>锁的等待、销毁时间单位由原来的<code>秒</code>改成<code>毫秒</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="truefixed-9"><a class="anchor" href="#truefixed-9"></a>8.9.3. Fixed</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>修正<code>tryLock</code>锁（<code>Redis</code>实现），锁被其它线程或JVM占用时等待时间的计算错误</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="true--55"><a class="anchor" href="#true--55"></a>9. 路线图</h2>
<div class="sectionbody">
<div class="paragraph">
<p>见 <a href="https://rep.360taihe.com/csp/dew-framework/milestones" class="bare">https://rep.360taihe.com/csp/dew-framework/milestones</a></p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-11-29 09:38:02 CST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>